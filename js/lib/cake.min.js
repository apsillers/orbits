window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)}}();Array.prototype.deleteFirst=function(a){for(var b=0;b<this.length;b++)if(this[b]==a)return this.splice(b,1),!0;return!1};Array.prototype.stableSort=function(a){for(var b=0;b<this.length;b++)this[b].__arrayPos=b;return this.sort(Array.__stableSorter(a))};
Array.__stableSorter=function(a){return function(b,c){var d=a(b,c);return!d?b.__arrayPos-c.__arrayPos:d}};Array.prototype.equals=function(a){if(!a||this.length!=a.length)return!1;for(var b=0;b<this.length;b++){var c=this[b],d=a[b];if(c.equals&&"function"==typeof c.equals){if(!c.equals(d))return!1}else if(c!=d)return!1}return!0};Array.prototype.rotate=function(a){if(a)return this.unshift(this.pop()),this[0];this.push(this.shift());return this[this.length-1]};
Array.prototype.pick=function(){return this[Math.floor(Math.random()*this.length)]};Array.prototype.flatten=function(){for(var a=[],b=0;b<this.length;b++){var c=this[b];if(c.flatten)for(var c=c.flatten(),d=0;d<c.length;d++)a[a.length]=c[d];else a[a.length]=c}return a};Array.prototype.take=function(){for(var a=[],b=0;b<this.length;b++){for(var c=[],d=0;d<arguments.length;d++)c[d]=this[b][arguments[d]];a[b]=c}return a};
Array.prototype.pluck||(Array.prototype.pluck=function(a){for(var b=[],c=0;c<this.length;c++)b[c]=this[c][a];return b});Array.prototype.set=function(a,b){for(var c=0;c<this.length;c++)this[c][a]=b};Array.prototype.allWith=function(){var a=[],b=0;a:for(;b<this.length;b++){for(var c=this[b],d=0;d<arguments.length;d++)if(!this[b][arguments[d]])continue a;a[a.length]=c}return a};Function.prototype.bind||(Function.prototype.bind=function(a){var b=this;return function(){return b.apply(a,arguments)}});
Array.prototype.last||(Array.prototype.last=function(){return this[this.length-1]});Array.prototype.indexOf||(Array.prototype.indexOf=function(a){for(var b=0;b<this.length;b++)if(a==this[b])return b;return-1});Array.prototype.includes||(Array.prototype.includes=function(a){return this.indexOf(a)>=0});Array.prototype.map=function(a){var b=Array(this.length);if(a)for(var c=0;c<this.length;c++)b[c]=a(this[c],c,this);else for(c=0;c<this.length;c++)b[c]=this[c];return b};
Array.prototype.forEach=function(a){for(var b=0;b<this.length;b++)a(this[b],b,this)};Array.prototype.reduce||(Array.prototype.reduce=function(a,b){var c=0;if(arguments.length==1){b=this[0];c++}for(;c<this.length;c++)b=a(b,this[c],c,this);return b});Array.prototype.find||(Array.prototype.find=function(a){for(var b=0;b<this.length;b++)if(a(this[b],b,this))return this[b]});String.prototype.capitalize||(String.prototype.capitalize=function(){return this.replace(/^./,this.slice(0,1).toUpperCase())});
String.prototype.escape||(String.prototype.escape=function(){return'"'+this.replace(/"/g,'\\"')+'"'});String.prototype.splice||(String.prototype.splice=function(a,b,c){return this.slice(0,a)+c+this.slice(a+b)});String.prototype.strip||(String.prototype.strip=function(){return this.replace(/^\s+|\s+$/g,"")});window.$A||($A=function(a){for(var b=Array(a.length),c=0;c<a.length;c++)b[c]=a[c];return b});window.$||($=function(a){return document.getElementById(a)});
Math.sinh||(Math.sinh=function(a){return 0.5*(Math.exp(a)-Math.exp(-a))},Math.asinh=function(a){return Math.log(a+Math.sqrt(a*a+1))});Math.cosh||(Math.cosh=function(a){return 0.5*(Math.exp(a)+Math.exp(-a))},Math.acosh=function(a){return Math.log(a+Math.sqrt(a*a-1))});
E=function(a,b,c){a=document.createElement(a);if(b){if(typeof b=="string"){a.innerHTML=b;b=c}else if(b.DOCUMENT_NODE){a.appendChild(b);b=c}if(b){if(b.style){c=b.style;b=Object.clone(b);delete b.style;Object.forceExtend(a.style,c)}if(b.content){typeof b.content=="string"?a.appendChild(T(b.content)):a.appendChild(b.content);b=Object.clone(b);delete b.content}Object.forceExtend(a,b)}}return a};
E.append=function(a){for(var b=1;b<arguments.length;b++)typeof arguments[b]=="string"?a.appendChild(T(arguments[b])):a.appendChild(arguments[b])};E.lastCanvasId=0;E.canvas=function(a,b,c){var d="canvas-uuid-"+E.lastCanvasId;E.lastCanvasId++;c||(c={});return E("canvas",Object.extend(c,{id:d,width:a,height:b}))};T=function(a){return document.createTextNode(a)};Object.forceExtend=function(a,b){for(var c in b)try{a[c]=b[c]}catch(d){}return a};Object.extend||(Object.extend=Object.forceExtend);
Object.conditionalExtend=function(a,b){for(var c in b)a[c]==null&&(a[c]=b[c]);return a};Object.clone=function(a){if(!a||a==true)return a;switch(typeof a){case "string":return Object.extend(a+"",a);case "number":return a;case "function":obj=eval(a.toSource());return Object.extend(obj,a);case "object":return a instanceof Array?Object.extend([],a):Object.extend({},a)}};Object.loadImage=function(a,b){var c=new Image;if(b)c.onload=b;c.src=a;return c};
Object.isImageLoaded=function(a){return a.tagName=="CANVAS"?true:!a.complete?false:a.naturalWidth==null?true:!!a.naturalWidth};Object.sum=function(a,b){if(a instanceof Array){if(b instanceof Array){for(var c=[],d=0;d<a.length;d++)c[d]=a[d]+b[d];return c}return a.map(function(a){return a+b})}return b instanceof Array?b.map(function(b){return b+a}):a+b};
Object.sub=function(a,b){if(a instanceof Array){if(b instanceof Array){for(var c=[],d=0;d<a.length;d++)c[d]=a[d]-b[d];return c}return a.map(function(a){return a-b})}return b instanceof Array?b.map(function(b){return a-b}):a-b};window.Mouse||(Mouse={});Mouse.getRelativeCoords=function(a,b){for(var c={x:0,y:0},d=0,e=0,f=a;f;){d=d+f.offsetLeft;e=e+f.offsetTop;f=f.offsetParent}c.x=b.pageX-d;c.y=b.pageY-e;return c};
Browser=function(){var a=window.navigator.userAgent,b=a.match(/KHTML/),c=a.match(/Gecko/),d=a.match(/WebKit\/\d+/),a=a.match(/Explorer/);return b?"KHTML":c?"Gecko":d?"Webkit":a?"IE":"UNKNOWN"}();Mouse.LEFT=0;Mouse.MIDDLE=1;Mouse.RIGHT=2;"IE"==Browser&&(Mouse.LEFT=1,Mouse.MIDDLE=4);
Klass=function(){var a=function(){this.initialize.apply(this,arguments)};a.ancestors=$A(arguments);a.prototype={};for(var b=0;b<arguments.length;b++){var c=arguments[b];c.prototype?Object.extend(a.prototype,c.prototype):Object.extend(a.prototype,c)}Object.extend(a,a.prototype);return a};
Curves={angularDistance:function(a,b){var c=Math.PI*2,d=(b-a)%c;d>Math.PI&&(d=d-c);d<-Math.PI&&(d=d+c);return d},linePoint:function(a,b,c){return[a[0]+(b[0]-a[0])*c,a[1]+(b[1]-a[1])*c]},quadraticPoint:function(a,b,c,d){var e=a[0]+(b[0]-a[0])*d,a=a[1]+(b[1]-a[1])*d;return[e+(b[0]+(c[0]-b[0])*d-e)*d,a+(b[1]+(c[1]-b[1])*d-a)*d]},cubicPoint:function(a,b,c,d,e){var f=a[0]*3,g=b[0]*3,h=c[0]*3,i=a[1]*3,b=b[1]*3,c=c[1]*3;return[a[0]+e*(g-f+e*(f-2*g+h+e*(g-a[0]-h+d[0]))),a[1]+e*(b-i+e*(i-2*b+c+e*(b-a[1]-c+
d[1])))]},linearValue:function(a,b,c){return a+(b-a)*c},quadraticValue:function(a,b,c,d){a=a+(b-a)*d;return a+(b+(c-b)*d-a)*d},cubicValue:function(a,b,c,d,e){var f=a*3,b=b*3,c=c*3;return a+e*(b-f+e*(f-2*b+c+e*(b-a-c+d)))},catmullRomPoint:function(a,b,c,d,e){var f=((-e+2)*e-1)*e*0.5,g=((3*e-5)*e*e+2)*0.5,h=((-3*e+4)*e+1)*e*0.5,e=(e-1)*e*e*0.5;return[a[0]*f+b[0]*g+c[0]*h+d[0]*e,a[1]*f+b[1]*g+c[1]*h+d[1]*e]},catmullRomAngle:function(a,b,c,d,e){return Math.atan2(0.5*(c[1]-a[1]+2*e*(2*a[1]-5*b[1]+4*c[1]-
d[1])+3*e*e*(3*b[1]+d[1]-a[1]-3*c[1])),0.5*(c[0]-a[0]+2*e*(2*a[0]-5*b[0]+4*c[0]-d[0])+3*e*e*(3*b[0]+d[0]-a[0]-3*c[0])))},catmullRomPointAngle:function(a,b,c,d,e){var f=this.catmullRomPoint(a,b,c,d,e),a=this.catmullRomAngle(a,b,c,d,e);return{point:f,angle:a}},lineAngle:function(a,b){return Math.atan2(b[1]-a[1],b[0]-a[0])},quadraticAngle:function(a,b,c,d){a=this.linePoint(a,b,d);b=this.linePoint(b,c,d);return this.lineAngle(a,b)},cubicAngle:function(a,b,c,d,e){a=this.quadraticPoint(a,b,c,e);b=this.quadraticPoint(b,
c,d,e);return this.lineAngle(a,b)},lineLength:function(a,b){var c=b[0]-a[0],d=b[1]-a[1];return Math.sqrt(c*c+d*d)},squareLineLength:function(a,b){var c=b[0]-a[0],d=b[1]-a[1];return c*c+d*d},quadraticLength:function(a,b,c,d){var e=this.linePoint(a,b,2/3),b=this.linePoint(b,c,1/3);return this.cubicLength(a,e,b,c,d)},cubicLength:function(){var a=function(b,c){for(var d=0,e=0;e<3;e++)d=d+Curves.lineLength(b[e],b[e+1]);e=Curves.lineLength(b[0],b[3]);if(d-e>c){for(var d=[b.slice(0)],f=1;f<4;f++){d[f]=[[],
[],[],[]];for(e=0;e<4-f;e++){d[f][e][0]=0.5*(d[f-1][e][0]+d[f-1][e+1][0]);d[f][e][1]=0.5*(d[f-1][e][1]+d[f-1][e+1][1])}}for(var f=[],g=[],e=0;e<4;e++){f[e]=d[e][0];g[e]=d[3-e][e]}d=[f,g];d=a(d[0],c)+a(d[1],c)}return d};return function(b,c,d,e,f){f||(f=1);return a([b,c,d,e],f)}}(),quadraticLengthPointAngle:function(a,b,c,d,e){d=this.linePoint(a,b,2/3);b=this.linePoint(b,c,1/3);return this.cubicLengthPointAngle(a,d,b,c,e)},cubicLengthPointAngle:function(a,b,c,d,e,f){for(var g=this.cubicLength(a,b,c,
d,f),h=f=a,i=0,j=0,g=e*g,e=1;e<=20;e++){h=f;f=this.cubicPoint(a,b,c,d,0.05*e);i=j;j=j+this.lineLength(h,f);if(j>=g){if(j==i)return{point:f,angle:this.lineAngle(a,b)};i=(j-g)/(j-i);return{point:this.linePoint(h,f,1-i),angle:this.cubicAngle(a,b,c,d,0.05*(e-i))}}}return{point:d.slice(0),angle:this.lineAngle(c,d)}}};
Colors={hsl2rgb:function(a,b,c){var d;if(b==0)a=d=b=v;else{var b=c<0.5?c*(1+b):c+b-c*b,c=2*c-b,e=a%360/360,a=e+1/3;d=e;e=e-1/3;a<0&&a++;a>1&&a--;d<0&&d++;d>1&&d--;e<0&&e++;e>1&&e--;a=a<1/6?c+(b-c)*6*a:a<0.5?b:a<2/3?c+(b-c)*6*(2/3-a):c;d=d<1/6?c+(b-c)*6*d:d<0.5?b:d<2/3?c+(b-c)*6*(2/3-d):c;b=e<1/6?c+(b-c)*6*e:e<0.5?b:e<2/3?c+(b-c)*6*(2/3-e):c}return[a,d,b]},hsv2rgb:function(a,b,c){var d,e,f;if(b==0)d=e=f=c;else{var a=a%360/60,g=Math.floor(a),h=a-g,a=c*(1-b),i=c*(1-b*h),b=c*(1-b*(1-h));switch(g){case 0:d=
c;e=b;f=a;break;case 1:d=i;e=c;f=a;break;case 2:d=a;e=c;f=b;break;case 3:d=a;e=i;f=c;break;case 4:d=b;e=a;f=c;break;case 5:d=c;e=a;f=i}}return[d,e,f]},parseColorStyle:function(a,b){if(typeof a=="string")return a;if(a.compiled)return a.compiled;if(a.isPattern)return a.compile(b);if(a.length==3)return"rgba("+a.map(Math.round).join(",")+", 1)";if(a.length==4)return"rgba("+Math.round(a[0])+","+Math.round(a[1])+","+Math.round(a[2])+","+a[3]+")";throw"Bad style: "+a;}};
CanvasSupport={DEVICE_SPACE:0,USER_SPACE:1,isPointInPathMode:null,supportsIsPointInPath:null,supportsCSSTransform:null,supportsCanvas:null,isCanvasSupported:function(){if(this.supportsCanvas==null){var a={};try{a=E("canvas")}catch(b){}this.supportsCanvas=a.getContext!=null}return this.supportsCanvas},isCSSTransformSupported:function(){if(this.supportsCSSTransform==null){var a=E("div").style;this.supportsCSSTransform=(a.webkitTransform!=null||a.MozTransform!=null)!=null}return this.supportsCSSTransform},
getTestContext:function(){if(!this.testContext)this.testContext=E.canvas(1,1).getContext("2d");return this.testContext},getSupportsAudioTag:function(){return!!E("audio").play},getSupportsSoundManager:function(){return window.soundManager&&soundManager.enabled},soundId:0,getSoundObject:function(){var a=null;this.getSupportsSoundManager()&&(a=this.getSoundManagerSoundObject());return a},getAudioTagSoundObject:function(){var a="sound-"+this.soundId++,a=E("audio",{id:a});a.load=function(a){this.src=a};
a.addEventListener("canplaythrough",function(){if(this.onready)this.onready()},false);a.setVolume=function(a){this.volume=a};a.setPan=function(a){this.pan=a};return a},getSoundManagerSoundObject:function(){var a="sound-"+this.soundId++,b={volume:100,pan:0,sid:a,load:function(a){return soundManager.load(this.sid,{url:a,autoPlay:false,volume:this.volume,pan:this.pan})},_onload:function(){if(this.onload)this.onload();if(this.onready)this.onready()},_onerror:function(){if(this.onerror)this.onerror()},
_onfinish:function(){if(this.onfinish)this.onfinish()},play:function(){return soundManager.play(this.sid)},stop:function(){return soundManager.stop(this.sid)},pause:function(){return soundManager.togglePause(this.sid)},setVolume:function(a){this.volume=a*100;return soundManager.setVolume(this.sid,a*100)},setPan:function(a){this.pan=a*100;return soundManager.setPan(this.sid,a*100)}};soundManager.createSound(a,"null.mp3");b.sound=soundManager.getSoundById(a);b.sound.options.onfinish=b._onfinish.bind(b);
b.sound.options.onload=b._onload.bind(b);b.sound.options.onerror=b._onerror.bind(b);return b},ContextSetterAugment:{setFillStyle:function(a){this.fillStyle=a},setStrokeStyle:function(a){this.strokeStyle=a},setGlobalAlpha:function(a){this.globalAlpha=a},setLineWidth:function(a){this.lineWidth=a},setLineCap:function(a){this.lineCap=a},setLineJoin:function(a){this.lineJoin=a},setMiterLimit:function(a){this.miterLimit=a},setGlobalCompositeOperation:function(a){this.globalCompositeOperation=a},setShadowColor:function(a){this.shadowColor=
a},setShadowBlur:function(a){this.shadowBlur=a},setShadowOffsetX:function(a){this.shadowOffsetX=a},setShadowOffsetY:function(a){this.shadowOffsetY=a},setMozTextStyle:function(a){this.mozTextStyle=a},setFont:function(a){this.font=a},setTextAlign:function(a){this.textAlign=a},setTextBaseline:function(a){this.textBaseline=a}},ContextJSImplAugment:{identity:function(){CanvasSupport.setTransform(this,[1,0,0,1,0,0])}},augment:function(a){Object.conditionalExtend(a,this.ContextSetterAugment);Object.conditionalExtend(a,
this.ContextJSImplAugment);return a},getContext:function(a,b){var c=a.getContext(b||"2d");this.augment(c);return c},tMatrixMultiply:function(a,b){var c=a[1]*b[0]+a[3]*b[1],d=a[0]*b[2]+a[2]*b[3],e=a[1]*b[2]+a[3]*b[3],f=a[0]*b[4]+a[2]*b[5]+a[4],g=a[1]*b[4]+a[3]*b[5]+a[5];a[0]=a[0]*b[0]+a[2]*b[1];a[1]=c;a[2]=d;a[3]=e;a[4]=f;a[5]=g;return a},tMatrixMultiplyPoint:function(a,b,c){return[b*a[0]+c*a[2]+a[4],b*a[1]+c*a[3]+a[5]]},tInvertMatrix:function(a){var b=1/(a[0]*a[3]-a[1]*a[2]);return[a[3]*b,-a[1]*b,
-a[2]*b,a[0]*b,b*(a[2]*a[5]-a[3]*a[4]),b*(a[1]*a[4]-a[0]*a[5])]},transform:function(a,b){if(a.transform)return a.transform.apply(a,b);a.translate(b[4],b[5]);if(Math.abs(b[1])<1.0E-6&&Math.abs(b[2])<1.0E-6)a.scale(b[0],b[3]);else{var c=this.svdTransform({xx:b[0],xy:b[2],yx:b[1],yy:b[3],dx:b[4],dy:b[5]});a.rotate(c.angle2);a.scale(c.sx,c.sy);a.rotate(c.angle1)}},brokenSvd:function(a){var b=[a[0],a[2],a[1],a[3],0,0],c=[b[0]*a[0]+b[2]*a[1],b[1]*a[0]+b[3]*a[1],b[0]*a[2]+b[2]*a[3],b[1]*a[2]+b[3]*a[3],0,
0],b=-(c[0]+c[3]),d=Math.sqrt(b*b-4*(-(c[1]*c[2])+c[0]*c[3])),e=(-b+d)/2,d=(-b-d)/2;if(e<d){b=e;e=d;d=b}var b=Math.sqrt(e),d=Math.sqrt(d),f=[1/b,0,0,1/d,0,0],e=(c[0]-e)/c[2],g=Math.sqrt(1+e*e),c=1/g,e=e/g,g=-e,h=[c,g,e,c,0,0],a=a.slice(0);this.tMatrixMultiply(a,h);this.tMatrixMultiply(a,f);return[a,[b,0,0,d,0,0],[c,e,g,c,0,0]]},svdTransform:function(){var a={Matrix2D:function(b){if(b)if(typeof b=="number")this.xx=this.yy=b;else if(b instanceof Array){if(b.length>0){for(var c=a.normalize(b[0]),d=1;d<
b.length;++d){var e=c,f=a.normalize(b[d]),c=new a.Matrix2D;c.xx=e.xx*f.xx+e.xy*f.yx;c.xy=e.xx*f.xy+e.xy*f.yy;c.yx=e.yx*f.xx+e.yy*f.yx;c.yy=e.yx*f.xy+e.yy*f.yy;c.dx=e.xx*f.dx+e.xy*f.dy+e.dx;c.dy=e.yx*f.dx+e.yy*f.dy+e.dy}Object.extend(this,c)}}else Object.extend(this,b)},normalize:function(b){return b instanceof a.Matrix2D?b:new a.Matrix2D(b)},multiply:function(b){for(var c=a.normalize(b),e=1;e<arguments.length;++e){var d=c,f=a.normalize(arguments[e]),c=new a.Matrix2D;c.xx=d.xx*f.xx+d.xy*f.yx;c.xy=
d.xx*f.xy+d.xy*f.yy;c.yx=d.yx*f.xx+d.yy*f.yx;c.yy=d.yx*f.xy+d.yy*f.yy;c.dx=d.xx*f.dx+d.xy*f.dy+d.dx;c.dy=d.yx*f.dx+d.yy*f.dy+d.dy}return c},invert:function(b){var b=a.normalize(b),c=b.xx*b.yy-b.xy*b.yx;return b=new a.Matrix2D({xx:b.yy/c,xy:-b.xy/c,yx:-b.yx/c,yy:b.xx/c,dx:(b.xy*b.dy-b.yy*b.dx)/c,dy:(b.yx*b.dx-b.xx*b.dy)/c})}};Object.extend(a.Matrix2D,{xx:1,xy:0,yx:0,yy:1,dx:0,dy:0});var b=function(a,b){return Math.abs(a-b)<=1.0E-6*(Math.abs(a)+Math.abs(b))},c=function(a,b){if(isFinite(a)){if(!isFinite(b))return a}else return b;
return(a+b)/2},d=function(c){var c=a.normalize(c),d=-c.xx-c.yy,e=c.xx*c.yy-c.xy*c.yx,f=Math.sqrt(d*d-4*e),d=-(d+(d<0?-f:f))/2,e=e/d,f=c.xy/(d-c.xx),k=1,l=c.xy/(e-c.xx),m=1;if(b(d,e)){f=1;l=k=0;m=1}if(!isFinite(f)){f=1;k=(d-c.xx)/c.xy;if(!isFinite(k)){f=(d-c.yy)/c.yx;k=1;if(!isFinite(f)){f=1;k=c.yx/(d-c.yy)}}}if(!isFinite(l)){l=1;m=(e-c.xx)/c.xy;if(!isFinite(m)){l=(e-c.yy)/c.yx;m=1;if(!isFinite(l)){l=1;m=c.yx/(e-c.yy)}}}var c=Math.sqrt(f*f+k*k),n=Math.sqrt(l*l+m*m);if(isNaN(f=f/c))f=0;if(isNaN(k=k/
c))k=0;if(isNaN(l=l/n))l=0;if(isNaN(m=m/n))m=0;return{value1:d,value2:e,vector1:{x:f,y:k},vector2:{x:l,y:m}}},e=function(a,b){var d=a.xx*a.yy<0||a.xy*a.yx>0?-1:1,e=b.angle1=(Math.atan2(a.yx,a.yy)+Math.atan2(-d*a.xy,d*a.xx))/2,d=Math.cos(e),e=Math.sin(e);b.sx=c(a.xx/d,-a.xy/e);b.sy=c(a.yy/d,a.yx/e);return b},f=function(a,b){var d=a.xx*a.yy<0||a.xy*a.yx>0?-1:1,e=b.angle2=(Math.atan2(d*a.yx,d*a.xx)+Math.atan2(-a.xy,a.yy))/2,d=Math.cos(e),e=Math.sin(e);b.sx=c(a.xx/d,a.yx/e);b.sy=c(a.yy/d,-a.xy/e);return b};
return function(c){var h=a.normalize(c),c={dx:h.dx,dy:h.dy,sx:1,sy:1,angle1:0,angle2:0};if(b(h.xy,0)&&b(h.yx,0))return Object.extend(c,{sx:h.xx,sy:h.yy});if(b(h.xx*h.yx,-h.xy*h.yy))return e(h,c);if(b(h.xx*h.xy,-h.yx*h.yy))return f(h,c);var i,j=new a.Matrix2D(h);i=Object.extend(j,{dx:0,dy:0,xy:j.yx,yx:j.xy});j=d([h,i]);i=d([i,h]);j=new a.Matrix2D({xx:j.vector1.x,xy:j.vector2.x,yx:j.vector1.y,yy:j.vector2.y});i=new a.Matrix2D({xx:i.vector1.x,xy:i.vector1.y,yx:i.vector2.x,yy:i.vector2.y});h=new a.Matrix2D([a.invert(j),
h,a.invert(i)]);e(i,c);h.xx=h.xx*c.sx;h.yy=h.yy*c.sy;f(j,c);h.xx=h.xx*c.sx;h.yy=h.yy*c.sy;return Object.extend(c,{sx:h.xx,sy:h.yy})}}(),setTransform:function(a,b,c){if(a.setTransform)return a.setTransform.apply(a,b);this.transform(a,this.tInvertMatrix(c));this.transform(a,b)},skewX:function(a,b){return this.transform(a,this.tSkewXMatrix(b))},skewY:function(a,b){return this.transform(a,this.tSkewYMatrix(b))},tRotate:function(a,b){var c=Math.cos(b),d=Math.sin(b),e=a[1]*c+a[3]*d,f=a[0]*-d+a[2]*c,g=a[1]*
-d+a[3]*c;a[0]=a[0]*c+a[2]*d;a[1]=e;a[2]=f;a[3]=g;return a},tTranslate:function(a,b,c){a[4]=a[4]+(a[0]*b+a[2]*c);a[5]=a[5]+(a[1]*b+a[3]*c);return a},tScale:function(a,b,c){a[0]=a[0]*b;a[1]=a[1]*b;a[2]=a[2]*c;a[3]=a[3]*c;return a},tSkewX:function(a,b){return this.tMatrixMultiply(a,this.tSkewXMatrix(b))},tSkewY:function(a,b){return this.tMatrixMultiply(a,this.tSkewYMatrix(b))},tSkewXMatrix:function(a){return[1,0,Math.tan(a),1,0,0]},tSkewYMatrix:function(a){return[1,Math.tan(a),0,1,0,0]},tRotationMatrix:function(a){var b=
Math.cos(a),a=Math.sin(a);return[b,a,-a,b,0,0]},tTranslationMatrix:function(a,b){return[1,0,0,1,a,b]},tScalingMatrix:function(a,b){return[a,0,0,b,0,0]},getTextBackend:function(){if(this.textBackend==null)this.textBackend=this.detectTextBackend();return this.textBackend},detectTextBackend:function(){var a=this.getTestContext();return a.fillText?"HTML5":a.mozDrawText?"MozText":a.drawString?"DrawString":"NONE"},getSupportsPutImageData:function(){if(this.supportsPutImageData==null){var a=this.getTestContext(),
b=a.putImageData;if(b)try{var c=a.getImageData(0,0,1,1);c[0]=255;c[1]=0;c[2]=255;c[3]=255;a.putImageData({width:1,height:1,data:c},0,0);c=a.getImageData(0,0,1,1);b=[255,0,255,255].equals(c.data)}catch(d){b=false}this.supportsPutImageData=b}return b},getSupportsIsPointInPath:function(){if(this.supportsIsPointInPath==null)this.supportsIsPointInPath=!!this.getTestContext().isPointInPath;return this.supportsIsPointInPath},getIsPointInPathMode:function(){if(this.isPointInPathMode==null)this.isPointInPathMode=
this.detectIsPointInPathMode();return this.isPointInPathMode},detectIsPointInPathMode:function(){var a=this.getTestContext(),b;if(!a.isPointInPath)return this.USER_SPACE;a.save();a.translate(1,0);a.beginPath();a.rect(0,0,1,1);b=a.isPointInPath(0.3,0.3)?this.USER_SPACE:this.DEVICE_SPACE;a.restore();return b},isPointInPath:function(a,b,c,d,e){if(a.isPointInPath){if(this.getIsPointInPathMode()==this.USER_SPACE)if(a.setTransform){a.save();a.setTransform(1,0,0,1,0,0);e=a.isPointInPath(b,c);a.restore()}else{b=
this.tMatrixMultiplyPoint(this.tInvertMatrix(d),b,c);e=a.isPointInPath(b[0],b[1])}else e=a.isPointInPath(b,c);return e}if(e&&e.isPointInPath){b=this.tMatrixMultiplyPoint(this.tInvertMatrix(d),b,c);return e.isPointInPath(b[0],b[1])}return false}};
RecordingContext=Klass({objectId:0,commands:[],isMockObject:!0,initialize:function(a){this.commands=a||[];Object.conditionalExtend(this,this.getMockContext())},getMockContext:function(){if(!RecordingContext.MockContext){var a=E.canvas(1,1),a=CanvasSupport.getContext(a,"2d"),b={},c;for(c in a)b[c]=typeof a[c]=="function"?this.createRecordingFunction(c):a[c];b.isPointInPath=null;b.transform=null;b.setTransform=null;RecordingContext.MockContext=b}return RecordingContext.MockContext},createRecordingFunction:function(a){if(a.search(/^set[A-Z]/)!=
-1&&a!="setTransform"){var b=a.charAt(3).toLowerCase()+a.slice(4);return function(){this[b]=arguments[0];this.commands.push([a,$A(arguments)])}}return function(){this.commands.push([a,$A(arguments)])}},clear:function(){this.commands=[]},getRecording:function(){return this.commands},serialize:function(a,b){return"("+{width:a,height:b,commands:this.getRecording()}.toSource()+")"},play:function(a){RecordingContext.play(a,this.getRecording())},createLinearGradient:function(){var a=this.objectId++;this.commands.push([a,
"=","createLinearGradient",$A(arguments)]);return new MockGradient(this,a)},createRadialGradient:function(){var a=this.objectId++;this.commands.push([a,"=","createRadialGradient",$A(arguments)]);return new this.MockGradient(this,a)},createPattern:function(){var a=this.objectId++;this.commands.push([a,"=","createPattern",$A(arguments)]);return new this.MockGradient(this,a)},MockGradient:Klass({isMockObject:!0,initialize:function(a,b){this.recorder=a;this.id=b},addColorStop:function(){this.recorder.commands.push([this.id,
"addColorStop",$A(arguments)])},toSource:function(){return{id:this.id,isMockObject:true}.toSource()}})});RecordingContext.play=function(a,b){for(var c=[],d=0;d<b.length;d++){var e=b[d];if(e.length==2){var f=e[1];if(f[0]&&f[0].isMockObject)a[e[0]](c[f[0].id]);else a[e[0]].apply(a,e[1])}else if(e.length==3){f=c[e[0]];f[e[1]].apply(f,e[2])}else if(e.length==4)c[e[0]]=a[e[2]].apply(a,e[3]);else throw"Malformed command: "+e.toString();}};
Transformable=Klass({needMatrixUpdate:!0,transform:function(a){var b=this.absoluteMatrix,c=this.x||this.y,d=this.rotation,e=this.scale!=null,f=this.skewX,g=this.skewY,h=this.matrix,i=this.transformList;if(this.needMatrixUpdate||!this.currentMatrix){if(!this.currentMatrix)this.currentMatrix=[1,0,0,1,0,0];this.parent?this.__copyMatrix(this.parent.currentMatrix):this.__identityMatrix();b&&this.__setMatrixMatrix(this.absoluteMatrix);c&&this.__translateMatrix(this.x,this.y);d&&this.__rotateMatrix(this.rotation);
f&&this.__skewXMatrix(this.skewX);g&&this.__skewYMatrix(this.skewY);e&&this.__scaleMatrix(this.scale);h&&this.__matrixMatrix(this.matrix);if(i)for(b=0;b<this.transformList.length;b++){i=this.transformList[b];this["__"+i[0]+"Matrix"](i[1])}this.needMatrixUpdate=false}a&&this.__setMatrix(a,this.currentMatrix)},distanceTo:function(a){return Curves.lineLength([this.x,this.y],[a.x,a.y])},angleTo:function(a){return Curves.lineAngle([this.x,this.y],[a.x,a.y])},__setMatrixMatrix:function(a){if(!this.previousMatrix)this.previousMatrix=
[];var b=this.previousMatrix,c=this.currentMatrix;b[0]=c[0];b[1]=c[1];b[2]=c[2];b[3]=c[3];b[4]=c[4];b[5]=c[5];b=this.currentMatrix;c=a;b[0]=c[0];b[1]=c[1];b[2]=c[2];b[3]=c[3];b[4]=c[4];b[5]=c[5]},__copyMatrix:function(a){var b=this.currentMatrix;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5]},__identityMatrix:function(){var a=this.currentMatrix;a[0]=1;a[1]=0;a[2]=0;a[3]=1;a[4]=0;a[5]=0},__translateMatrix:function(a,b){a.length?CanvasSupport.tTranslate(this.currentMatrix,a[0],a[1]):CanvasSupport.tTranslate(this.currentMatrix,
a,b)},__rotateMatrix:function(a){if(a.length){if(a[0]%(Math.PI*2)!=0)if(a[1]||a[2]){CanvasSupport.tTranslate(this.currentMatrix,a[1],a[2]);CanvasSupport.tRotate(this.currentMatrix,a[0]);CanvasSupport.tTranslate(this.currentMatrix,-a[1],-a[2])}else CanvasSupport.tRotate(this.currentMatrix,a[0])}else a%(Math.PI*2)!=0&&CanvasSupport.tRotate(this.currentMatrix,a)},__skewXMatrix:function(a){a.length&&a[0]?CanvasSupport.tSkewX(this.currentMatrix,a[0]):CanvasSupport.tSkewX(this.currentMatrix,a)},__skewYMatrix:function(a){a.length&&
a[0]?CanvasSupport.tSkewY(this.currentMatrix,a[0]):CanvasSupport.tSkewY(this.currentMatrix,a)},__scaleMatrix:function(a){if(a.length==2)a[0]==1&&a[1]==1||CanvasSupport.tScale(this.currentMatrix,a[0],a[1]);else if(a.length==3){if(!(a[0]==1||a[0].length&&a[0][0]==1&&a[0][1]==1)){CanvasSupport.tTranslate(this.currentMatrix,a[1],a[2]);a[0].length?CanvasSupport.tScale(this.currentMatrix,a[0][0],a[0][1]):CanvasSupport.tScale(this.currentMatrix,a[0],a[0]);CanvasSupport.tTranslate(this.currentMatrix,-a[1],
-a[2])}}else a!=1&&CanvasSupport.tScale(this.currentMatrix,a,a)},__matrixMatrix:function(a){CanvasSupport.tMatrixMultiply(this.currentMatrix,a)},__setMatrix:function(a,b){CanvasSupport.setTransform(a,b,this.previousMatrix)},__translate:function(a,b,c){b.length!=null?a.translate(b[0],b[1]):a.translate(b,c)},__rotate:function(a,b){if(b.length)if(b[1]||b[2]){if(b[0]%(Math.PI*2)!=0){a.translate(b[1],b[2]);a.rotate(b[0]);a.translate(-b[1],-b[2])}}else a.rotate(b[0]);else a.rotate(b)},__skewX:function(a,
b){b.length&&b[0]?CanvasSupport.skewX(a,b[0]):CanvasSupport.skewX(a,b)},__skewY:function(a,b){b.length&&b[0]?CanvasSupport.skewY(a,b[0]):CanvasSupport.skewY(a,b)},__scale:function(a,b){if(b.length==2)a.scale(b[0],b[1]);else if(b.length==3){a.translate(b[1],b[2]);b[0].length?a.scale(b[0][0],b[0][1]):a.scale(b[0],b[0]);a.translate(-b[1],-b[2])}else a.scale(b,b)},__matrix:function(a,b){CanvasSupport.transform(a,b)}});
Timeline=Klass({startTime:null,repeat:!1,lastAction:0,initialize:function(a){this.repeat=a;this.keyframes=[]},addKeyframe:function(a,b,c){arguments.length==1?this.keyframes.push(a):this.keyframes.push({time:a,target:b,tween:c})},appendKeyframe:function(a,b,c){this.lastAction=this.lastAction+a;return this.addKeyframe(this.lastAction,b,c)},evaluate:function(a,b){if(this.startTime==null)this.startTime=b;var c=b-this.startTime;if(this.keyframes.length>0){for(var d,e,f,g=0;g<this.keyframes.length;g++)if(this.keyframes[g].time>
c){d=g;break}if(d!=null){e=this.keyframes[d-1];f=this.keyframes[d]}if(f){if(e){this.keyframes.atEnd=false;var c=(c-e.time)/(f.time-e.time),h;for(h in f.target)e.target[h]!=null&&a.tweenVariable(h,e.target[h],f.target[h],c,f.tween)}}else if(!this.keyframes.atEnd){this.keyframes.atEnd=true;e=this.keyframes[this.keyframes.length-1];Object.extend(a,Object.clone(e.target));if(this.repeat)this.startTime=b;a.changed=true}}}});
Animatable=Klass({tweenFunctions:{linear:function(a){return a},set:function(a){return Math.floor(a)},discrete:function(a){return Math.floor(a)},sine:function(a){return 0.5-0.5*Math.cos(a*Math.PI)},sproing:function(a){return(0.5-0.5*Math.cos(a*3.59261946538606))*1.05263157894737},square:function(a){return a*a},cube:function(a){return a*a*a},sqrt:function(a){return Math.sqrt(a)},curt:function(a){return Math.pow(a,-0.333333333333)}},initialize:function(){this.lastAction=0;this.timeline=[];this.keyframes=
[];this.pendingKeyframes=[];this.pendingTimelineEvents=[];this.timelines=[];this.animators=[];this.addFrameListener(this.updateTimelines);this.addFrameListener(this.updateKeyframes);this.addFrameListener(this.updateTimeline);this.addFrameListener(this.updateAnimators)},updateTimelines:function(a,b){for(var c=0;c<this.timelines.length;c++)this.timelines[c].evaluate(this,a,b)},addTimeline:function(a){this.timelines.push(a)},removeTimeline:function(a){this.timelines.deleteFirst(a)},updateKeyframes:function(a){this.addPendingKeyframes(a);
if(this.keyframes.length>0){for(var b,c,d,e=0;e<this.keyframes.length;e++)if(this.keyframes[e].time>a){b=e;break}if(b!=null){c=this.keyframes[b-1];d=this.keyframes[b]}if(d){if(c){this.keyframes.atEnd=false;var a=(a-c.time)/(d.time-c.time),f;for(f in d.target)c.target[f]!=null&&this.tweenVariable(f,c.target[f],d.target[f],a,d.tween)}}else if(!this.keyframes.atEnd){this.keyframes.atEnd=true;c=this.keyframes[this.keyframes.length-1];Object.extend(this,Object.clone(c.target));this.changed=true}}},addPendingKeyframes:function(a){if(this.pendingKeyframes.length>
0){for(;this.pendingKeyframes.length>0;){var b=this.pendingKeyframes.shift();if(b.time==null)b.time=b.relativeTime+a;this.keyframes.push(b)}this.keyframes.stableSort(function(a,b){return a.time-b.time})}},updateTimeline:function(a,b){for(this.addPendingTimelineEvents(a);this.timeline[0]&&this.timeline[0].startTime<=a;){var c=this.timeline.shift(),d=true;typeof c.action=="function"?d=c.action.call(this,a,b,c):this.animators.push(c.action);if(c.repeatEvery!=null&&d!=false){if(c.repeatTimes!=null){if(c.repeatTimes<=
0)continue;c.repeatTimes--}c.startTime=c.startTime+c.repeatEvery;this.addTimelineEvent(c)}this.changed=true}},addPendingTimelineEvents:function(a){if(this.pendingTimelineEvents.length>0){for(;this.pendingTimelineEvents.length>0;){var b=this.pendingTimelineEvents.shift();if(!b.startTime)b.startTime=b.relativeStartTime+a;this.timeline.push(b)}this.timeline.stableSort(function(a,b){return a.startTime-b.startTime})}},addTimelineEvent:function(a){this.pendingTimelineEvents.push(a)},updateAnimators:function(a){for(var b=
0;b<this.animators.length;b++){var c=this.animators[b];if(!c.startTime)c.startTime=a;var d=(a-c.startTime)/c.duration,e=false;if(d>=1)if(c.repeat){if(c.repeat!==true)c.repeat=Math.max(0,c.repeat-1);if(c.accumulate){c.startValue=Object.clone(c.endValue);c.endValue=Object.sum(c.difference,c.endValue)}if(c.repeat==0){e=true;d=1}else{c.startTime=a;d=d%1}}else{d=1;e=true}else if(c.repeat&&c.repeat!==true&&c.repeat<=d){e=true;d=c.repeat}this.tweenVariable(c.variable,c.startValue,c.endValue,d,c.tween);if(e){this.animators.splice(b,
1);b--}}},tweenVariable:function(a,b,c,d,e){typeof e!="function"&&(e=this.tweenFunctions[e]||this.tweenFunctions.linear);d=e(d);if(typeof a!="function")if(b instanceof Array)for(e=0;e<b.length;e++)this[a][e]=b[e]+d*(c[e]-b[e]);else this[a]=b+d*(c-b);else a.call(this,d,b,c);this.changed=true},animate:function(a,b,c,d,e,f){b=Object.clone(b);c=Object.clone(c);f||(f={});if(f.additive)var g=Object.sub(c,b),b=Object.sum(b,this[a]),c=Object.sum(c,this[a]);typeof a!="function"&&(this[a]=Object.clone(b));
a={id:Animatable.uid++,variable:a,startValue:b,endValue:c,difference:g,duration:d,tween:e,repeat:f.repeat,additive:f.additive,accumulate:f.accumulate,pingpong:f.pingpong};this.animators.push(a);return a},removeAnimator:function(a){this.animators.deleteFirst(a)},animateTo:function(a,b,c,d,e){return this.animate(a,this[a],b,c,d,e)},animateFrom:function(a,b,c,d,e){return this.animate(a,b,this[a],c,d,e)},animateFactor:function(a,b,c,d,e,f){var g;if(b instanceof Array){g=[];for(var h=0;h<b.length;h++)g[h]=
b[h]*c}else g=b*c;return this.animate(a,b,g,d,e,f)},animateToFactor:function(a,b,c,d,e){return this.animateFactor(a,this[a],b,c,d,e)},addKeyframe:function(a,b,c){this.pendingKeyframes.push({relativeTime:a,target:b,tween:c})},addKeyframeAt:function(a,b,c){this.pendingKeyframes.push({time:a,target:b,tween:c})},appendKeyframe:function(a,b,c){this.lastAction=this.lastAction+a;return this.addKeyframe(this.lastAction,b,c)},every:function(a,b,c){a={action:b,relativeStartTime:c?a:0,repeatEvery:a};this.addTimelineEvent(a);
return a},at:function(a,b){var c={action:b,startTime:a};this.addTimelineEvent(c);return c},after:function(a,b){var c={action:b,relativeStartTime:a};this.addTimelineEvent(c);return c},afterFrame:function(a,b){var c=0,d;d=function(){if(c>=a){b.call(this);this.removeFrameListener(d)}c++};this.addFrameListener(d);return d},everyFrame:function(a,b,c){var d=c?0:a,e;e=function(){if(d>=a){b.call(this)==false&&this.removeFrameListener(e);d=0}d++};this.addFrameListener(e);return e}});Animatable.uid=0;
CanvasNode=Klass(Animatable,Transformable,{OBJECTBOUNDINGBOX:"objectBoundingBox",visible:!0,drawable:!0,display:null,visibility:null,catchMouse:!0,pickable:!1,underCursor:!1,zIndex:0,x:0,y:0,scale:1,rotation:0,matrix:null,absoluteMatrix:null,transformList:null,fill:null,stroke:null,strokeWidth:null,lineCap:null,lineJoin:null,miterLimit:null,absoluteOpacity:null,opacity:null,fillOpacity:null,strokeOpacity:null,compositeOperation:null,shadowColor:null,shadowBlur:null,shadowOffsetX:null,shadowOffsetY:null,
font:null,textAlign:null,textBaseline:null,cursor:null,changed:!0,tagName:"g",getNextSibling:function(){return this.parentNode?this.parentNode.childNodes[this.parentNode.childNodes.indexOf(this)+1]:null},getPreviousSibling:function(){return this.parentNode?this.parentNode.childNodes[this.parentNode.childNodes.indexOf(this)-1]:null},initialize:function(a){this.root=this;this.currentMatrix=[1,0,0,1,0,0];this.previousMatrix=[1,0,0,1,0,0];this.needMatrixUpdate=true;this.childNodes=[];this.frameListeners=
[];this.eventListeners={};Animatable.initialize.call(this);a&&Object.extend(this,a)},clone:function(){var a=Object.clone(this);a.parent=a.root=null;for(var b in this)typeof this[b]=="object"&&(a[b]=Object.clone(this[b]));a.parent=a.root=null;a.childNodes=[];a.setRoot(null);for(b=0;b<this.childNodes.length;b++){var c=this.childNodes[b].clone();a.append(c)}return a},cloneNode:function(){return this.clone()},getElementById:function(a){if(this.id==a)return this;for(var b=0;b<this.childNodes.length;b++){var c=
this.childNodes[b].getElementById(a);if(c)return c}return null},$:function(a){return this.getElementById(a)},appendChild:function(){return this.append.apply(this,arguments)},append:function(a){for(var b=$A(arguments),c=0;c<b.length;c++){b[c].parent&&b[c].removeSelf();this.childNodes.push(b[c]);b[c].parent=b[c].parentNode=this;b[c].setRoot(this.root)}this.changed=true},removeAllChildren:function(){this.remove.apply(this,this.childNodes)},removeChild:function(){return this.remove.apply(this,arguments)},
remove:function(a){for(var b=arguments,c=0;c<b.length;c++){this.childNodes.deleteFirst(b[c]);delete b[c].parent;delete b[c].parentNode;b[c].setRoot(null)}this.changed=true},removeSelf:function(){this.parentNode&&this.parentNode.remove(this)},contains:function(a){for(;a;){if(a==this)return true;a=a.parentNode}return false},setRoot:function(a){a||(a=this);this.dispatchEvent({type:"rootChanged",canvasTarget:this,relatedTarget:a});this.root=a;for(var b=0;b<this.childNodes.length;b++)this.childNodes[b].setRoot(a)},
addFrameListener:function(a){this.frameListeners.push(a)},removeFrameListener:function(a){this.frameListeners.deleteFirst(a)},addEventListener:function(a,b,c){this.eventListeners[a]||(this.eventListeners[a]={capture:[],bubble:[]});this.eventListeners[a][c?"capture":"bubble"].push(b)},when:function(a,b,c){this.addEventListener(a,b,c||false)},removeEventListener:function(a,b,c){if(this.eventListeners[a]){this.eventListeners[a][c?"capture":"bubble"].deleteFirst(b);this.eventListeners[a].capture.length==
0&&this.eventListeners[a].bubble.length==0&&delete this.eventListeners[a]}},dispatchEvent:function(a){var b=a.type;if(!a.canvasTarget){a.canvasTarget=b.search(/^(key|text)/i)==0?this.root.focused||this.root.target:this.root.target;if(!a.canvasTarget)a.canvasTarget=this}for(var b=[],c=a.canvasTarget;c&&c!=this;){b.push(c);c=c.parent}b.push(this);a.canvasPhase="capture";for(c=b.length-1;c>=0;c--)if(!b[c].handleEvent(a))return false;a.canvasPhase="bubble";for(c=0;c<b.length;c++)if(!b[c].handleEvent(a))return false;
return true},broadcastEvent:function(a){a.canvasPhase="capture";if(!this.handleEvent(a))return false;for(var b=0;b<this.childNodes.length;b++)if(!this.childNodes[b].broadcastEvent(a))return false;a.canvasPhase="bubble";return!this.handleEvent(a)?false:true},handleEvent:function(a){var b=a.type,c=a.canvasPhase;if(this.cursor&&c=="capture")a.cursor=this.cursor;if(b=(b=this.eventListeners[b])&&b[c])for(c=0;c<b.length;c++)if(b[c].call(this,a)==false||a.stopped){a.stopped||a.stopPropagation();a.stopped=
true;return false}return true},handleUpdate:function(a,b){this.update(a,b);this.willBeDrawn=(!this.parent||this.parent.willBeDrawn)&&(this.display?this.display!="none":this.visible);for(var c=0;c<this.childNodes.length;c++)this.childNodes[c].handleUpdate(a,b);if(this.parent&&this.changed){this.parent.changed=this.changed;this.changed=false}this.needMatrixUpdate=true},update:function(a,b){for(var c=this.frameListeners.slice(0),d=0;d<c.length;d++)this.frameListeners.includes(c[d])&&c[d].apply(this,
arguments)},handlePick:function(a){if(this.display)this.visible=this.display!="none";if(this.visibility)this.drawable=this.visibility!="hidden";this.underCursor=false;if(this.visible&&this.catchMouse&&this.root.absoluteMouseX!=null){a.save();this.transform(a,true);if(this.pickable&&this.drawable){if(a.isPointInPath){a.beginPath();this.drawPickingPath&&this.drawPickingPath(a)}if(this.underCursor=CanvasSupport.isPointInPath(this.drawPickingPath?a:false,this.root.mouseX,this.root.mouseY,this.currentMatrix,
this))this.root.target=this}else this.underCursor=false;var b=this.__getChildrenCopy();this.__zSort(b);for(var c=0;c<b.length;c++){b[c].handlePick(a);if(!this.underCursor)this.underCursor=b[c].underCursor}a.restore()}else for(b=this.__getChildrenCopy();b.length>0;){a=b.pop();if(a.underCursor){a.underCursor=false;Array.prototype.push.apply(b,a.childNodes)}}},__zSort:function(a){a.stableSort(function(a,c){return a.zIndex-c.zIndex})},__getChildrenCopy:function(){if(this.__childNodesCopy){for(;this.__childNodesCopy.length>
this.childNodes.length;)this.__childNodesCopy.pop();for(var a=0;a<this.childNodes.length;a++)this.__childNodesCopy[a]=this.childNodes[a]}else this.__childNodesCopy=this.childNodes.slice(0);return this.__childNodesCopy},isPointInPath:!1,handleDraw:function(a){if(this.display)this.visible=this.display!="none";if(this.visibility)this.drawable=this.visibility!="hidden";if(this.visible){a.save();var b=a.fontFamily,c=a.fontSize,d=a.fillOn,e=a.strokeOn;if(this.fontFamily)a.fontFamily=this.fontFamily;if(this.fontSize)a.fontSize=
this.fontSize;this.transform(a);if(this.clipPath){a.beginPath();if(this.clipPath.units==this.OBJECTBOUNDINGBOX){var f=this.getSubtreeBoundingBox(true);a.save();a.translate(f[0],f[1]);a.scale(f[2],f[3]);this.clipPath.createSubtreePath(a,true);a.restore()}else this.clipPath.createSubtreePath(a,true);a.clip()}this.drawable&&this.draw&&this.draw(a);f=this.__getChildrenCopy();this.__zSort(f);for(var g=0;g<f.length;g++)f[g].handleDraw(a);a.fontFamily=b;a.fontSize=c;a.fillOn=d;a.strokeOn=e;a.restore()}},
transform:function(a,b){Transformable.prototype.transform.call(this,a);if(!b){if(this.fill!=null)if(!this.fill||this.fill=="none")a.fillOn=false;else{a.fillOn=true;if(this.fill!=true){var c=Colors.parseColorStyle(this.fill,a);a.setFillStyle(c)}}if(this.stroke!=null)if(!this.stroke||this.stroke=="none")a.strokeOn=false;else{a.strokeOn=true;this.stroke!=true&&a.setStrokeStyle(Colors.parseColorStyle(this.stroke,a))}this.strokeWidth!=null&&a.setLineWidth(this.strokeWidth);this.lineCap!=null&&a.setLineCap(this.lineCap);
this.lineJoin!=null&&a.setLineJoin(this.lineJoin);this.miterLimit!=null&&a.setMiterLimit(this.miterLimit);this.absoluteOpacity!=null&&a.setGlobalAlpha(this.absoluteOpacity);this.opacity!=null&&a.setGlobalAlpha(a.globalAlpha*this.opacity);this.compositeOperation!=null&&a.setGlobalCompositeOperation(this.compositeOperation);this.shadowColor!=null&&a.setShadowColor(Colors.parseColorStyle(this.shadowColor,a));this.shadowBlur!=null&&a.setShadowBlur(this.shadowBlur);this.shadowOffsetX!=null&&a.setShadowOffsetX(this.shadowOffsetX);
this.shadowOffsetY!=null&&a.setShadowOffsetY(this.shadowOffsetY);this.textAlign!=null&&a.setTextAlign(this.textAlign);this.textBaseline!=null&&a.setTextBaseline(this.textBaseline);this.font!=null&&a.setFont(this.font)}},drawPickingPath:!1,draw:!1,createSubtreePath:function(a,b){a.save();b||this.transform(a,true);for(var c=0;c<this.childNodes.length;c++)this.childNodes[c].createSubtreePath(a);a.restore()},getSubtreeBoundingBox:function(a){if(a){var b=this.parent;this.parent=null;this.needMatrixUpdate=
true}for(var c=this.getAxisAlignedBoundingBox(),d=0;d<this.childNodes.length;d++){var e=this.childNodes[d].getSubtreeBoundingBox();c?e&&this.mergeBoundingBoxes(c,e):c=e}if(a){this.parent=b;this.needMatrixUpdate=true}return c},mergeBoundingBoxes:function(a,b){var c=a[0],d=a[1];a[0]>b[0]&&(a[0]=b[0]);a[1]>b[1]&&(a[1]=b[1]);a[2]=a[2]+c-a[0];a[3]=a[3]+d-a[1];a[2]+a[0]<b[2]+b[0]&&(a[2]=b[2]+b[0]-a[0]);a[3]+a[1]<b[3]+b[1]&&(a[3]=b[3]+b[1]-a[1])},getAxisAlignedBoundingBox:function(){this.transform(null,
true);if(!this.getBoundingBox)return null;var a=this.getBoundingBox(),b=CanvasSupport.tMatrixMultiplyPoint(this.currentMatrix,a[0],a[1]),c=CanvasSupport.tMatrixMultiplyPoint(this.currentMatrix,a[0]+a[2],a[1]+a[3]),d=CanvasSupport.tMatrixMultiplyPoint(this.currentMatrix,a[0],a[1]+a[3]),e=CanvasSupport.tMatrixMultiplyPoint(this.currentMatrix,a[0]+a[2],a[1]),a=Math.min(b[0],c[0],d[0],e[0]),f=Math.max(b[0],c[0],d[0],e[0]),g=Math.min(b[1],c[1],d[1],e[1]),b=Math.max(b[1],c[1],d[1],e[1]);return[a,g,f-a,
b-g]},makeDraggable:function(){this.addEventListener("dragstart",function(a){this.dragStartPosition={x:this.x,y:this.y};a.stopPropagation();a.preventDefault();return false},false);this.addEventListener("drag",function(a){this.x=this.dragStartPosition.x+this.root.dragX/this.parent.currentMatrix[0];this.y=this.dragStartPosition.y+this.root.dragY/this.parent.currentMatrix[3];a.stopPropagation();a.preventDefault();return false},false)}});
Canvas=Klass(CanvasNode,{clear:!0,frameLoop:!1,recording:!1,opacity:1,frame:0,elapsed:0,frameDuration:30,speed:1,time:0,fps:0,currentRealFps:0,currentFps:0,fpsFrames:30,startTime:0,realFps:0,fixedTimestep:!1,playOnlyWhenFocused:!0,isPlaying:!0,redrawOnlyWhenChanged:!1,changed:!0,drawBoundingBoxes:!1,cursor:"default",mouseDown:!1,mouseEvents:[],absoluteMouseX:null,absoluteMouseY:null,mouseX:null,mouseY:null,elementNodeZIndexCounter:0,initialize:function(a,b){if(arguments.length>2){var c=arguments[0],
d=arguments[1],e=arguments[2],b=arguments[3],a=E.canvas(d,e);this.canvasContainer=d=E("div",a,{style:{overflow:"hidden",width:d+"px",height:e+"px",position:"relative"}});c&&c.appendChild(d)}CanvasNode.initialize.call(this,b);this.mouseEventStack=[];this.canvas=a;a.canvas=this;this.width=this.canvas.width;this.height=this.canvas.height;var f=this;this.frameHandler=function(){f.onFrame()};this.canvas.addEventListener("DOMNodeInserted",function(a){a.target==this&&f.addEventListeners()},false);this.canvas.addEventListener("DOMNodeRemoved",
function(a){a.target==this&&f.removeEventListeners()},false);this.canvas.parentNode&&this.addEventListeners();this.startTime=(new Date).getTime();this.isPlaying&&this.play()},removeEventListeners:function(){},addEventListeners:function(){var a=this;this.canvas.parentNode.addMouseEvent=function(b){b=Mouse.getRelativeCoords(this,b);a.absoluteMouseX=b.x;a.absoluteMouseY=b.y;var c=document.defaultView.getComputedStyle(a.canvas,""),b=parseFloat(c.getPropertyValue("width")),c=parseFloat(c.getPropertyValue("height"));
a.mouseX=a.absoluteMouseX*(b/a.canvas.width);a.mouseY=a.absoluteMouseY*(c/a.canvas.height);a.addMouseEvent(a.mouseX,a.mouseY,a.mouseDown)};this.canvas.parentNode.contains=this.contains;this.canvas.parentNode.addEventListener("mousedown",function(b){a.mouseDown=true;if(a.keyTarget!=a.target){a.keyTarget&&a.dispatchEvent({type:"blur",canvasTarget:a.keyTarget});a.keyTarget=a.target;a.keyTarget&&a.dispatchEvent({type:"focus",canvasTarget:a.keyTarget})}this.addMouseEvent(b)},true);this.canvas.parentNode.addEventListener("mouseup",
function(b){this.addMouseEvent(b);a.mouseDown=false},true);this.canvas.parentNode.addEventListener("mousemove",function(b){this.addMouseEvent(b);if(a.prevClientX==null){a.prevClientX=b.clientX;a.prevClientY=b.clientY}if(a.dragTarget){var c=document.createEvent("MouseEvents");c.initMouseEvent("drag",true,true,window,b.detail,b.screenX,b.screenY,b.clientX,b.clientY,b.ctrlKey,b.altKey,b.shiftKey,b.metaKey,b.button,b.relatedTarget);c.canvasTarget=a.dragTarget;c.dx=b.clientX-a.prevClientX;c.dy=b.clientY-
a.prevClientY;a.dragX=a.dragX+c.dx;a.dragY=a.dragY+c.dy;a.dispatchEvent(c)}if(a.mouseDown){if(!a.dragTarget&&a.target){a.dragTarget=a.target;c=document.createEvent("MouseEvents");c.initMouseEvent("dragstart",true,true,window,b.detail,b.screenX,b.screenY,b.clientX,b.clientY,b.ctrlKey,b.altKey,b.shiftKey,b.metaKey,b.button,b.relatedTarget);c.canvasTarget=a.dragTarget;a.dragStartX=b.clientX;a.dragStartY=b.clientY;a.dragX=a.dragY=0;a.dispatchEvent(c)}}else if(a.dragTarget){c=document.createEvent("MouseEvents");
c.initMouseEvent("dragend",true,true,window,b.detail,b.screenX,b.screenY,b.clientX,b.clientY,b.ctrlKey,b.altKey,b.shiftKey,b.metaKey,b.button,b.relatedTarget);c.canvasTarget=a.dragTarget;a.dispatchEvent(c);a.dragX=a.dragY=0;a.dragTarget=false}a.prevClientX=b.clientX;a.prevClientY=b.clientY},true);this.canvas.parentNode.addEventListener("mouseout",function(b){if(!CanvasNode.contains.call(this,b.relatedTarget))a.absoluteMouseX=a.absoluteMouseY=a.mouseX=a.mouseY=null},true);for(var b=this.dispatchEvent.bind(this),
c=["mousemove","mouseover","mouseout","click","dblclick","mousedown","mouseup","keypress","keydown","keyup","DOMMouseScroll","mousewheel","mousemultiwheel","textInput","focus","blur"],d=0;d<c.length;d++)this.canvas.parentNode.addEventListener(c[d],b,false);this.keys={};this.windowEventListeners={keydown:function(b){if(a.keyTarget){a.updateKeys(b);b.canvasTarget=a.keyTarget;a.dispatchEvent(b)}},keyup:function(b){if(a.keyTarget){a.updateKeys(b);b.canvasTarget=a.keyTarget;a.dispatchEvent(b)}},keypress:function(b){if(a.keyTarget){b.canvasTarget=
a.keyTarget;a.dispatchEvent(b)}},blur:function(){a.absoluteMouseX=a.absoluteMouseY=null;if(a.playOnlyWhenFocused&&a.isPlaying){a.stop();a.__blurStop=true}},focus:function(){a.__blurStop&&!a.isPlaying&&a.play()},mouseup:function(b){a.mouseDown=false;if(a.dragTarget){var c=document.createEvent("MouseEvents");c.initMouseEvent("dragend",true,true,window,b.detail,b.screenX,b.screenY,b.clientX,b.clientY,b.ctrlKey,b.altKey,b.shiftKey,b.metaKey,b.button,b.relatedTarget);c.canvasTarget=a.dragTarget;a.dispatchEvent(c);
a.dragTarget=false}if(!a.canvas.parentNode.contains(b.target)){b=a.dispatchEvent(b);if(a.keyTarget){a.dispatchEvent({type:"blur",canvasTarget:a.keyTarget});a.keyTarget=null}return b}},mousemove:function(b){a.__blurStop&&!a.isPlaying&&a.play();if(!a.canvas.parentNode.contains(b.target)&&a.mouseDown)return a.dispatchEvent(b)}};this.canvas.parentNode.addEventListener("DOMNodeRemoved",function(b){b.target==this&&a.removeWindowEventListeners()},false);this.canvas.parentNode.addEventListener("DOMNodeInserted",
function(b){b.target==this&&a.addWindowEventListeners()},false);this.canvas.parentNode.parentNode&&this.addWindowEventListeners()},updateKeys:function(a){this.keys.shift=a.shiftKey;this.keys.ctrl=a.ctrlKey;this.keys.alt=a.altKey;this.keys.meta=a.metaKey;var b=a.type=="keydown";switch(a.keyCode){case 37:this.keys.left=b;break;case 38:this.keys.up=b;break;case 39:this.keys.right=b;break;case 40:this.keys.down=b;break;case 32:this.keys.space=b;break;case 13:this.keys.enter=b;break;case 9:this.keys.tab=
b;break;case 8:this.keys.backspace=b;break;case 16:this.keys.shift=b;break;case 17:this.keys.ctrl=b;break;case 18:this.keys.alt=b}this.keys[a.keyCode]=b},addWindowEventListeners:function(){for(var a in this.windowEventListeners)window.addEventListener(a,this.windowEventListeners[a],false)},removeWindowEventListeners:function(){for(var a in this.windowEventListeners)window.removeEventListener(a,this.windowEventListeners[a],false)},addMouseEvent:function(a,b,c){var d=this.allocMouseEvent();d[0]=a;d[1]=
b;d[2]=c;this.mouseEvents.push(d)},allocMouseEvent:function(){return this.mouseEventStack.length>0?this.mouseEventStack.pop():[null,null,null]},freeMouseEvent:function(a){this.mouseEventStack.push(a);this.mouseEventStack.length>100&&this.mouseEventStack.splice(0,this.mouseEventStack.length)},clearMouseEvents:function(){for(;this.mouseEvents.length>0;)this.freeMouseEvent(this.mouseEvents.pop())},createFrameLoop:function(){var a=this,b={running:true,stop:function(){this.running=false},run:function(){if(b.running){a.onFrame();
requestAnimFrame(b.run,a.canvas)}}};requestAnimFrame(b.run,this.canvas);return b},play:function(){this.stop();this.realTime=(new Date).getTime();this.frameLoop=this.createFrameLoop();this.isPlaying=true},stop:function(){this.__blurStop=false;if(this.frameLoop){this.frameLoop.stop();this.frameLoop=null}this.isPlaying=false},dispatchEvent:function(a){var b=CanvasNode.prototype.dispatchEvent.call(this,a);if(a.cursor){if(this.canvas.style.cursor!=a.cursor)this.canvas.style.cursor=a.cursor}else if(this.canvas.style.cursor!=
this.cursor)this.canvas.style.cursor=this.cursor;return b},onFrame:function(a,b){this.elementNodeZIndexCounter=0;var c=this.getContext();try{var d=(new Date).getTime();this.currentRealElapsed=d-this.realTime;this.currentRealFps=1E3/this.currentRealElapsed;var e=this.frameDuration*this.speed;this.fixedTimestep||(e=this.currentRealElapsed*this.speed);this.realTime=d;if(a!=null){this.time=a;b&&(e=b)}else this.time=this.time+e;this.previousTarget=this.target;this.target=null;this.catchMouse&&this.handlePick(c);
if(this.previousTarget!=this.target){if(this.previousTarget){var f=document.createEvent("MouseEvents");f.initMouseEvent("mouseout",true,true,window,0,0,0,0,0,false,false,false,false,0,null);f.canvasTarget=this.previousTarget;this.dispatchEvent(f)}if(this.target){f=document.createEvent("MouseEvents");f.initMouseEvent("mouseover",true,true,window,0,0,0,0,0,false,false,false,false,0,null);f.canvasTarget=this.target;this.dispatchEvent(f)}}this.handleUpdate(this.time,e);this.clearMouseEvents();if(!this.redrawOnlyWhenChanged||
this.changed){try{this.handleDraw(c)}catch(g){console.log(g);throw g;}this.changed=false}this.currentElapsed=(new Date).getTime()-this.realTime;this.elapsed=this.elapsed+this.currentElapsed;this.currentFps=1E3/this.currentElapsed;this.frame++;if(this.frame%this.fpsFrames==0){this.fps=this.fpsFrames*1E3/this.elapsed;this.realFps=this.fpsFrames*1E3/((new Date).getTime()-this.startTime);this.elapsed=0;this.startTime=(new Date).getTime()}}catch(h){if(c)try{for(d=0;d<1E3;d++)c.restore()}catch(i){}delete this.context;
throw h;}},getContext:function(){return this.recording?this.getRecordingContext():this.useMockContext?this.getMockContext():this.get2DContext()},get2DContext:function(){if(!this.context)this.context=CanvasSupport.getContext(this.canvas,"2d");return this.context},getMockContext:function(){if(!this.fakeContext){var a=this.get2DContext();this.fakeContext={};var b=function(){return this},c;for(c in a)this.fakeContext[c]=typeof a[c]=="function"?b:a[c];this.fakeContext.isMockObject=true;this.fakeContext.addColorStop=
b}return this.fakeContext},getRecordingContext:function(){if(!this.recordingContext)this.recordingContext=new RecordingContext;return this.recordingContext},drawPickingPath:function(a){a.rect(0,0,this.canvas.width,this.canvas.height)},isPointInPath:function(a,b){return a>=0&&a<=this.canvas.width&&b>=0&&b<=this.canvas.height},draw:function(a){a.setGlobalAlpha(this.opacity);if(this.clear)if(a.fillOn){a.beginPath();a.rect(0,0,this.canvas.width,this.canvas.height);a.fill()}else a.clearRect(0,0,this.canvas.width,
this.canvas.height);a.fillStyle="black";a.strokeStyle="black";a.fillOn=false;a.strokeOn=false}});
LinkNode=Klass(CanvasNode,{href:null,target:"_self",cursor:"pointer",initialize:function(a,b,c){this.href=a;if(b)this.target=b;CanvasNode.initialize.call(this,c);this.setupLinkEventListeners()},setupLinkEventListeners:function(){this.addEventListener("click",function(a){if(a.button!=Mouse.RIGHT){var b=this.target;if((a.ctrlKey||a.button==Mouse.MIDDLE)&&b=="_self")b="_blank";window.open(this.href,b)}},false)}});
AudioNode=Klass(CanvasNode,{ready:!1,autoPlay:!1,playing:!1,paused:!1,pan:0,volume:1,loop:!1,transformSound:!1,initialize:function(a,b){CanvasNode.initialize.call(this,b);this.filename=a;this.when("load",this._autoPlaySound);this.loadSound()},loadSound:function(){if(this.sound=CanvasSupport.getSoundObject()){var a=this;this.sound.onready=function(){a.ready=true;a.root.dispatchEvent({type:"ready",canvasTarget:a})};this.sound.onload=function(){a.loaded=true;a.root.dispatchEvent({type:"load",canvasTarget:a})};
this.sound.onerror=function(){a.root.dispatchEvent({type:"error",canvasTarget:a})};this.sound.onfinish=function(){a.loop?a.play():a.stop()};this.sound.load(this.filename)}},play:function(){this.needPlayUpdate=this.playing=true},stop:function(){this.playing=false;this.needPlayUpdate=true},pause:function(){if(this.needPauseUpdate)this.needPauseUpdate=false;else{this.paused=!this.paused;this.needPauseUpdate=true}},setVolume:function(a){this.volume=a;this.needStatusUpdate=true},setPan:function(a){this.pan=
a;this.needStatusUpdate=true},handleUpdate:function(){CanvasNode.handleUpdate.apply(this,arguments);if(this.willBeDrawn){this.transform(null,true);this.sound||this.loadSound();if(this.ready){if(this.transformSound){var a=this.currentMatrix[4],b=this.currentMatrix[2],c=this.currentMatrix[3],d=this.currentMatrix[0],e=this.currentMatrix[1],f=this.root.width*0.5,b=Math.sqrt(b*b+c*c);Math.sqrt(d*d+e*e);this.setVolume(b);this.setPan((a-f)/f)}if(this.needPauseUpdate){this.needPauseUpdate=false;this._pauseSound()}if(this.needPlayUpdate){this.needPlayUpdate=
false;this.playing?this._playSound():this._stopSound()}if(this.needStatusUpdate){this._setSoundVolume();this._setSoundPan()}}}},_autoPlaySound:function(){this.autoPlay&&this.play()},_setSoundVolume:function(){this.sound.setVolume(this.volume)},_setSoundPan:function(){this.sound.setPan(this.pan)},_playSound:function(){if(this.sound.play()==false)return this.playing=false;this.root.dispatchEvent({type:"play",canvasTarget:this})},_stopSound:function(){this.sound.stop();this.root.dispatchEvent({type:"stop",
canvasTarget:this})},_pauseSound:function(){this.sound.pause();this.root.dispatchEvent({type:this.paused?"pause":"play",canvasTarget:this})}});
ElementNode=Klass(CanvasNode,{noScaling:!1,noAlpha:!1,inherit:"inherit",align:null,valign:null,xOffset:0,yOffset:0,initialize:function(a,b){CanvasNode.initialize.call(this,b);this.content=a;this.element=E("div",a);this.element.style.MozTransformOrigin=this.element.style.webkitTransformOrigin="0 0";this.element.style.position="absolute"},clone:function(){var a=CanvasNode.prototype.clone.call(this);if(this.content&&this.content.cloneNode)a.content=this.content.cloneNode(true);a.element=E("div",a.content);
a.element.style.position="absolute";a.element.style.MozTransformOrigin=a.element.style.webkitTransformOrigin="0 0";return a},setRoot:function(a){CanvasNode.setRoot.call(this,a);this.element&&this.element.parentNode&&this.element.parentNode.removeChild&&this.element.parentNode.removeChild(this.element)},handleUpdate:function(a,b){CanvasNode.handleUpdate.call(this,a,b);if(!this.willBeDrawn||!this.visible||this.display=="none"||this.visibility=="hidden"||!this.drawable){if(this.element.style.display!=
"none")this.element.style.display="none"}else if(this.element.style.display=="none")this.element.style.display="block"},addEventListener:function(a,b,c){var d=this;return this.element.addEventListener(a,function(){b.apply(d,arguments)},c||false)},removeEventListener:function(a,b,c){var d=this;return this.element.removeEventListener(a,function(){b.apply(d,arguments)},c||false)},draw:function(a){if(this.cursor&&this.element.style.cursor!=this.cursor)this.element.style.cursor=this.cursor;if(this.element.style.zIndex!=
this.root.elementNodeZIndexCounter)this.element.style.zIndex=this.root.elementNodeZIndexCounter;this.root.elementNodeZIndexCounter++;var b=this.currentMatrix;xo=this.xOffset;yo=this.yOffset;if(this.fillBoundingBox&&this.parent&&this.parent.getBoundingBox){var c=this.parent.getBoundingBox();xo=xo+c[0];yo=yo+c[1]}var d=CanvasSupport.tMatrixMultiplyPoint(b.slice(0,4).concat([0,0]),xo,yo),e=this.currentMatrix[4]+d[0],d=this.currentMatrix[5]+d[1],f=this.currentMatrix[2],g=this.currentMatrix[3],h=this.currentMatrix[0],
i=this.currentMatrix[1],f=Math.sqrt(f*f+g*g),h=Math.sqrt(h*h+i*i);if(a.fontFamily!=null)this.element.style.fontFamily=a.fontFamily;i=CanvasSupport.isCSSTransformSupported();this.element.style.MozTransform=i&&!this.noScaling?this.element.style.webkitTransform="matrix("+b.join(",")+")":this.element.style.webkitTransform="";this.element.style.fontSize=a.fontSize!=null?this.noScaling||i?a.fontSize+"px":a.fontSize*f+"px":this.noScaling||i?"inherit":100*f+"%";this.element.style.opacity=this.noAlpha?1:a.globalAlpha;
if(!this.element.parentNode&&this.root.canvas.parentNode){this.element.style.visibility="hidden";this.root.canvas.parentNode.appendChild(this.element);var j=true}b=this.color||this.fill;if(this.parent){if(!b||!b.length)b=this.parent.color;if(!b||!b.length)b=this.parent.fill}if(!b||!b.length)b=a.fillStyle;if(typeof b=="string")this.element.style.color=b.search(/^rgba\(/)!=-1?"rgb("+b.match(/\d+/g).slice(0,3).join(",")+")":b;else if(b.length)this.element.style.color="rgb("+b.slice(0,3).map(Math.floor).join(",")+
")";b=a=0;if(c){this.element.style.width=Math.floor(h*c[2])+"px";this.element.style.height=Math.floor(f*c[3])+"px";this.eWidth=h;this.eHeight=f}else{this.element.style.width="";this.element.style.height="";g=this.align||this.textAnchor;c=[0,0];if(g=="center"||g=="middle"){a=-this.element.offsetWidth/2;c[0]="50%"}else if(g=="right"){a=-this.element.offsetWidth;c[0]="100%"}g=this.valign;if(g=="center"||g=="middle"){b=-this.element.offsetHeight/2;c[1]="50%"}else if(g=="bottom"){b=-this.element.offsetHeight;
c[1]="100%"}this.element.style.webkitTransformOrigin=this.element.style.MozTransformOrigin=c.join(" ");this.eWidth=this.element.offsetWidth/h;this.eHeight=this.element.offsetHeight/f}if(i&&!this.noScaling){this.element.style.left=Math.floor(a)+"px";this.element.style.top=Math.floor(b)+"px"}else{this.element.style.left=Math.floor(e+a)+"px";this.element.style.top=Math.floor(d+b)+"px"}if(j)this.element.style.visibility="visible"}});
Drawable=Klass(CanvasNode,{pickable:!0,strokeMode:"above",ABOVE:"above",BELOW:"below",INSIDE:"inside",initialize:function(a){CanvasNode.initialize.call(this,a)},drawPickingPath:function(a){if(this.drawGeometry){a.beginPath();this.drawGeometry(a)}},isPointInPath:function(){return false},isVisible:function(a){var b=this.getAxisAlignedBoundingBox();if(!b)return true;var c=b[0],d=b[0]+b[2],e=b[1],b=b[1]+b[3],f=this.root.width,g=this.root.height;if(this.root.drawBoundingBoxes){a.save();var h=this.getBoundingBox();
a.beginPath();a.rect(h[0],h[1],h[2],h[3]);a.strokeStyle="green";a.lineWidth=1;a.stroke();a.restore();a.save();CanvasSupport.setTransform(a,[1,0,0,1,0,0],this.currentMatrix);a.beginPath();a.rect(c,e,d-c,b-e);a.strokeStyle="red";a.lineWidth=1.5;a.stroke();a.restore()}return!(d<0||c>f||b<0||e>g)},createSubtreePath:function(a,b){a.save();b||this.transform(a,true);this.drawGeometry&&this.drawGeometry(a);for(var c=0;c<this.childNodes.length;c++)this.childNodes[c].createSubtreePath(a);a.restore()},draw:function(a){if(this.drawGeometry){this.root.drawBoundingBoxes&&
this.isVisible(a);var b=a.fillStyle.transformList||a.fillStyle.matrix||a.fillStyle.scale!=null||a.fillStyle.rotation||a.fillStyle.x||a.fillStyle.y,c=a.strokeStyle.transformList||a.strokeStyle.matrix||a.strokeStyle.scale!=null||a.strokeStyle.rotation||a.strokeStyle.x||a.strokeStyle.y;a.beginPath();this.drawGeometry(a);if(a.strokeOn)switch(this.strokeMode){case this.ABOVE:a.fillOn&&this.doFill(a,b);this.doStroke(a,c);break;case this.BELOW:this.doStroke(a,c);a.fillOn&&this.doFill(a,b);break;case this.INSIDE:a.fillOn&&
this.doFill(a,b);a.save();b=a.lineWidth;a.setLineWidth(1);this.doStroke(a,c);a.setLineWidth(b);a.clip();this.doStroke(a,c);a.restore()}else a.fillOn&&this.doFill(a,b);this.drawMarkers(a);this.clip&&a.clip()}},doFill:function(a,b){if(b||this.getBoundingBox&&a.fillStyle.units==this.OBJECTBOUNDINGBOX){a.save();if(this.getBoundingBox&&a.fillStyle.units==this.OBJECTBOUNDINGBOX){var c=this.getBoundingBox(),d=c[2],e=c[3];a.translate(c[0],c[1]);a.scale(d,e)}a.fillStyle.transform(a)}if(this.fillOpacity!=null){c=
a.globalAlpha;a.setGlobalAlpha(c*this.fillOpacity);a.fill();a.globalAlpha=c}else a.fill();b&&a.restore()},doStroke:function(a,b){if(b||this.getBoundingBox&&a.strokeStyle.units==this.OBJECTBOUNDINGBOX){a.save();if(this.getBoundingBox&&a.strokeStyle.units==this.OBJECTBOUNDINGBOX){var c=this.getBoundingBox(),d=c[2],e=c[3];a.translate(c[0],c[1]);a.scale(d,e)}a.strokeStyle.needMatrixUpdate=true;a.strokeStyle.transform(a);d!=null&&CanvasSupport.tScale(a.strokeStyle.currentMatrix,d,e);c=a.strokeStyle.currentMatrix;
c=Math.sqrt(Math.max(c[0]*c[0]+c[1]*c[1],c[2]*c[2]+c[3]*c[3]));a.setLineWidth((a.lineWidth==null?1:a.lineWidth)/c)}if(this.strokeOpacity!=null){c=a.globalAlpha;a.setGlobalAlpha(c*this.strokeOpacity);a.stroke();a.globalAlpha=c}else a.stroke();b&&a.restore()},drawMarkers:function(a){var b=this.markerStart||this.marker,c=this.markerEnd||this.marker,d=this.markerMid||this.marker;if(b&&this.getStartPoint){var e=this.getStartPoint();if(b.orient!=null&&b.orient!="auto")e.angle=b.orient;var f=b.markerUnits==
"strokeWidth"?a.lineWidth:1;a.save();a.translate(e.point[0],e.point[1]);a.scale(f,f);a.rotate(e.angle);e=CanvasSupport.tRotate(CanvasSupport.tScale(CanvasSupport.tTranslate(this.currentMatrix.slice(0),e.point[0],e.point[1]),f,f),e.angle);b.__copyMatrix(e);b.handleDraw(a);a.restore()}if(c&&this.getEndPoint){e=this.getEndPoint();if(c.orient!=null&&c.orient!="auto")e.angle=c.orient;f=c.markerUnits=="strokeWidth"?a.lineWidth:1;a.save();a.translate(e.point[0],e.point[1]);a.scale(f,f);a.rotate(e.angle);
e=CanvasSupport.tRotate(CanvasSupport.tScale(CanvasSupport.tTranslate(this.currentMatrix.slice(0),e.point[0],e.point[1]),f,f),e.angle);c.__copyMatrix(e);c.handleDraw(a);a.restore()}if(d&&this.getMidPoints)for(var b=this.getMidPoints(),f=d.markerUnits=="strokeWidth"?a.lineWidth:1,g=0;g<b.length;g++){e=b[g];a.save();a.translate(e.point[0],e.point[1]);a.scale(f,f);if(d.orient!=null&&d.orient!="auto")e.angle=c.orient;a.rotate(e.angle);e=CanvasSupport.tRotate(CanvasSupport.tScale(CanvasSupport.tTranslate(this.currentMatrix.slice(0),
e.point[0],e.point[1]),f,f),e.angle);d.__copyMatrix(e);d.handleDraw(a);a.restore()}},getStartPoint:!1,getEndPoint:!1,getMidPoints:!1,getBoundingBox:!1});
Line=Klass(Drawable,{x1:0,y1:0,x2:0,y2:0,stroke:!0,initialize:function(a,b,c,d,e){this.x1=a;this.y1=b;this.x2=c;this.y2=d;Drawable.initialize.call(this,e)},drawGeometry:function(a){a.moveTo(this.x1,this.y1);a.lineTo(this.x2,this.y2)},getStartPoint:function(){return{point:[this.x1,this.y1],angle:Math.atan2(this.y2-this.y1,this.x2-this.x1)}},getEndPoint:function(){return{point:[this.x2,this.y2],angle:Math.atan2(this.y2-this.y1,this.x2-this.x1)}},getBoundingBox:function(){return[this.x1,this.y1,this.x2-
this.x1,this.y2-this.y1]},getLength:function(){return Curves.lineLength([this.x1,this.y1],[this.x2,this.y2])}});
Circle=Klass(Drawable,{cx:0,cy:0,radius:10,startAngle:0,endAngle:2*Math.PI,clockwise:!1,closePath:!0,includeCenter:!1,initialize:function(a,b){if(a!=null)this.radius=a;Drawable.initialize.call(this,b)},drawGeometry:function(a){if(this.radius!=0){this.includeCenter&&a.moveTo(this.cx,this.cy);a.arc(this.cx,this.cy,this.radius,this.startAngle,this.endAngle,this.clockwise);if(this.closePath){var b=Math.cos(this.endAngle),c=Math.sin(this.endAngle);a.moveTo(this.cx+b*this.radius,this.cy+c*this.radius);
a.closePath()}}},isPointInPath:function(a,b){a=a-this.cx;b=b-this.cy;return a*a+b*b<=this.radius*this.radius},getBoundingBox:function(){return[this.cx-this.radius,this.cy-this.radius,2*this.radius,2*this.radius]}});
Ellipse=Klass(Circle,{radiusX:0,radiusY:0,initialize:function(a,b,c){this.radiusX=a;this.radiusY=b;Circle.initialize.call(this,1,c)},drawGeometry:function(a){if(!(this.radiusX==0||this.radiusY==0)){var b=this.cx,c=this.cy,d=0.5522847498*this.radiusX,e=0.5522847498*this.radiusY;a.moveTo(b+this.radiusX,c);a.bezierCurveTo(b+this.radiusX,c-e,b+d,c-this.radiusY,b,c-this.radiusY);a.bezierCurveTo(b-d,c-this.radiusY,b-this.radiusX,c-e,b-this.radiusX,c);a.bezierCurveTo(b-this.radiusX,c+e,b-d,c+this.radiusY,
b,c+this.radiusY);a.bezierCurveTo(b+d,c+this.radiusY,b+this.radiusX,c+e,b+this.radiusX,c)}},isPointInPath:function(a,b){a=a-this.cx;b=b-this.cy;a=a/this.radiusX;b=b/this.radiusY;return a*a+b*b<=1},getBoundingBox:function(){return[this.cx-this.radiusX,this.cy-this.radiusY,this.radiusX*2,this.radiusY*2]}});
Spiral=Klass(Drawable,{cx:0,cy:0,startRadius:0,startAngle:0,endAngle:0,radiusFunction:function(a){return a},initialize:function(a,b){this.endAngle=a;Drawable.initialize.call(this,b)},drawGeometry:function(a){var b=this.cx,c=this.cy,d=this.startAngle,e=this.startRadius+this.radiusFunction(d);a.moveTo(b+Math.cos(d)*e,c-Math.sin(d)*e);if(this.startAngle<this.endAngle){d=d+0.1;for(e=this.startRadius+this.radiusFunction(d);d<this.endAngle;){a.lineTo(b+Math.cos(d)*e,c-Math.sin(d)*e);d=d+0.1;e=this.startRadius+
this.radiusFunction(d)}}else{d=d-0.1;for(e=this.startRadius+this.radiusFunction(d);d>this.endAngle;){a.lineTo(b+Math.cos(d)*e,c-Math.sin(d)*e);d=d-0.1;e=this.startRadius+this.radiusFunction(d)}}d=this.endAngle;e=this.startRadius+this.radiusFunction(d);a.lineTo(b+Math.cos(d)*e,c-Math.sin(d)*e)},isPointInPath:function(){return false}});
Rectangle=Klass(Drawable,{cx:0,cy:0,x2:0,y2:0,width:0,height:0,rx:0,ry:0,centered:!1,initialize:function(a,b,c){if(a!=null)this.height=this.width=a;if(b!=null)this.height=b;Drawable.initialize.call(this,c)},drawGeometry:function(a){var b=this.cx,c=this.cy,d=this.width||this.x2-b,e=this.height||this.y2-c;if(!(d==0||e==0)){if(this.centered){b=b-0.5*d;c=c-0.5*e}if(this.rx||this.ry){var f=Math.min(d*0.5,this.rx||this.ry),g=Math.min(e*0.5,this.ry||f),h=0.5522847498*f,i=0.5522847498*g;a.moveTo(b+f,c);a.lineTo(b-
f+d,c);a.bezierCurveTo(b-f+d+h,c,b+d,c+g-i,b+d,c+g);a.lineTo(b+d,c+e-g);a.bezierCurveTo(b+d,c+e-g+i,b-f+d+h,c+e,b-f+d,c+e);a.lineTo(b+f,c+e);a.bezierCurveTo(b+f-h,c+e,b,c+e-g+i,b,c+e-g);a.lineTo(b,c+g);a.bezierCurveTo(b,c+g-i,b+f-h,c,b+f,c);a.closePath()}else{d<0&&(b=b+d);e<0&&(c=c+e);a.rect(b,c,Math.abs(d),Math.abs(e))}}},isPointInPath:function(a,b){a=a-this.cx;b=b-this.cy;if(this.centered){a=a+this.width/2;b=b+this.height/2}return a>=0&&a<=this.width&&b>=0&&b<=this.height},getBoundingBox:function(){var a=
this.cx,b=this.cy;if(this.centered){a=a-this.width/2;b=b-this.height/2}return[a,b,this.width,this.height]}});
Polygon=Klass(Drawable,{segments:[],closePath:!0,initialize:function(a,b){this.segments=a;Drawable.initialize.call(this,b)},drawGeometry:function(a){if(this.segments&&!(this.segments.length<2)){var b=this.segments;a.moveTo(b[0],b[1]);for(var c=2;c<b.length;c=c+2)a.lineTo(b[c],b[c+1]);this.closePath&&a.closePath()}},isPointInPath:function(a,b){if(!this.segments||this.segments.length<2)return false;var c=this.getBoundingBox();return a>=c[0]&&a<=c[0]+c[2]&&b>=c[1]&&b<=c[1]+c[3]},getStartPoint:function(){if(!this.segments||
this.segments.length<2)return{point:[0,0],angle:0};var a=0;this.segments.length>2&&(a=Curves.lineAngle(this.segments.slice(0,2),this.segments.slice(2,4)));return{point:this.segments.slice(0,2),angle:a}},getEndPoint:function(){if(!this.segments||this.segments.length<2)return{point:[0,0],angle:0};var a=0;this.segments.length>2&&(a=Curves.lineAngle(this.segments.slice(-4,-2),this.segments.slice(-2)));return{point:this.segments.slice(-2),angle:a}},getMidPoints:function(){if(!this.segments||this.segments.length<
2)return[];for(var a=this.segments,b=[],c=2;c<a.length-2;c=c+2){var d=a.slice(c-2,c),e=a.slice(c,c+2),f=a.slice(c+2,c+4),d=0.5*(Curves.lineAngle(d,e)+Curves.lineAngle(e,f));b.push({point:e,angle:d})}return b},getBoundingBox:function(){for(var a=Infinity,b=Infinity,c=-Infinity,d=-Infinity,e=this.segments,f=0;f<e.length;f=f+2){var g=e[f],h=e[f+1];g<a&&(a=g);g>c&&(c=g);h<b&&(b=h);h>d&&(d=h)}return[a,b,c-a,d-b]}});
CatmullRomSpline=Klass(Drawable,{segments:[],loop:!1,closePath:!1,initialize:function(a,b){this.segments=a;Drawable.initialize.call(this,b)},drawGeometry:function(a){var b=this.currentMatrix[0],c=this.currentMatrix[1],d=this.currentMatrix[2],e=this.currentMatrix[3],c=Math.floor(Math.sqrt(Math.max(b*b+c*c,d*d+e*e))),b=this.compiled;if(!b||b.scale!=c)b=this.compile(c);for(c=0;c<b.length;c++){d=b[c];a[d[0]].apply(a,d[1])}this.closePath&&a.closePath()},compile:function(a){a||(a=1);var b=[];if(this.segments&&
this.segments.length>=(this.loop?1:4)){var c=this.segments;if(this.loop){c=c.slice(0);c.unshift(c[c.length-1]);c.push(c[1]);c.push(c[2])}var d=1/(15*(a+0.5)),e,f,g,h,i;b.push(["moveTo",c[1].slice(0)]);for(var j=1;j<c.length-2;j++){e=c[j-1];f=c[j];g=c[j+1];h=c[j+2];for(var k=0;k<1;k=k+d){i=Curves.catmullRomPoint(e,f,g,h,k);b.push(["lineTo",i])}}i=Curves.catmullRomPoint(e,f,g,h,1);b.push(["lineTo",i])}b.scale=a;return this.compiled=b},getBoundingBox:function(){for(var a=Infinity,b=Infinity,c=-Infinity,
d=-Infinity,e=this.compiled?this.compiled:this.compile(),f=0;f<e.length;f++)for(var g=e[f][1],h=0;h<g.length;h=h+2){var i=g[h],j=g[h+1];i<a&&(a=i);i>c&&(c=i);j<b&&(b=j);j>d&&(d=j)}return[a,b,c-a,d-b]},pointAt:function(a){if(!this.segments)return[0,0];if(this.segments.length>=(this.loop?1:4)){var b=this.segments;if(this.loop){b=b.slice(0);b.unshift(b[b.length-1]);b.push(b[1]);b.push(b[2])}var a=a*(b.length-3),c=Math.floor(a);return Curves.catmullRomPoint(b[c],b[c+1],b[c+2],b[c+3],a-c)}return this.segments[0]},
pointAngleAt:function(a){if(!this.segments)return{point:[0,0],angle:0};if(this.segments.length>=(this.loop?1:4)){var b=this.segments;if(this.loop){b=b.slice(0);b.unshift(b[b.length-1]);b.push(b[1]);b.push(b[2])}var a=a*(b.length-3),c=Math.floor(a);return Curves.catmullRomPointAngle(b[c],b[c+1],b[c+2],b[c+3],a-c)}return{point:this.segments[0]||[0,0],angle:0}}});
Path=Klass(Drawable,{segments:[],closePath:!1,initialize:function(a,b){this.segments=a;Drawable.initialize.call(this,b)},drawGeometry:function(a){for(var b=this.getSegments(),c=0;c<b.length;c++){var d=b[c];a[d[0]].apply(a,d[1])}this.closePath&&a.closePath()},isPointInPath:function(a,b){var c=this.getBoundingBox();return a>=c[0]&&a<=c[0]+c[2]&&b>=c[1]&&b<=c[1]+c[3]},getBoundingBox:function(){if(!this.compiled||!this.compiledBoundingBox){for(var a=Infinity,b=Infinity,c=-Infinity,d=-Infinity,e=this.getSegments(),
f=0;f<e.length;f++)for(var g=e[f][1],h=0;h<g.length;h=h+2){var i=g[h],j=g[h+1];i<a&&(a=i);i>c&&(c=i);j<b&&(b=j);j>d&&(d=j)}this.compiledBoundingBox=[a,b,c-a,d-b]}return this.compiledBoundingBox},getStartPoint:function(){var a=this.getSegments();if(!a||!a[0])return{point:[0,0],angle:0};var b=a[0][1],b=[b[b.length-2],b[b.length-1]],a=a[1],c=0;if(a){c2=a[1];c=Curves.lineAngle(b,[c2[c2.length-2],c2[c2.length-1]])}return{point:b,angle:c}},getEndPoint:function(){var a=this.getSegments();if(!a||!a[0])return{point:[0,
0],angle:0};var b=a[a.length-1][1],b=[b[b.length-2],b[b.length-1]],a=a[a.length-2],c=0;if(a){c2=a[1];c=Curves.lineAngle([c2[c2.length-2],c2[c2.length-1]],b)}return{point:b,angle:c}},getMidPoints:function(){var a=this.getSegments();if(this.vertices)return this.vertices.slice(1,-1);for(var b=[],c=1;c<a.length-1;c++){var d=a[c-1][1].slice(-2),e=a[c][1].slice(0,2);if(a[c-1].length>2)var f=a[c-1][1].slice(-4,-2),e=0.5*(Curves.lineAngle(f,d)+Curves.lineAngle(d,e));else e=Curves.lineAngle(d,e);b.push({point:d,
angle:e});d=a[c][2];if(d!=null){for(c++;a[c]&&a[c][2]==d;)c++;c--}}return b},getSegments:function(){if(typeof this.segments=="string"){if(!this.compiled||this.segments!=this.compiledSegments){this.compiled=this.compileSVGPath(this.segments);this.compiledSegments=this.segments}}else if(!this.compiled)this.compiled=Object.clone(this.segments);return this.compiled},compileSVGPath:function(a){for(var a=a.split(/(?=[a-z])/i),b=0,c=0,d,e,f,g=[],h=0;h<a.length;h++){var i=a[h],j=i.match(/[a-z]/i);if(!j)return[];
j=j[0];(i=i.match(/[+-]?\d+(\.\d+(e\d+(\.\d+)?)?)?/gi))&&(i=i.map(parseFloat));switch(j){case "M":b=i[0];c=i[1];d=e=null;g.push(["moveTo",[b,c]]);break;case "m":b=b+i[0];c=c+i[1];d=e=null;g.push(["moveTo",[b,c]]);break;case "L":b=i[0];c=i[1];d=e=null;g.push(["lineTo",[b,c]]);break;case "l":b=b+i[0];c=c+i[1];d=e=null;g.push(["lineTo",[b,c]]);break;case "H":b=i[0];d=e=null;g.push(["lineTo",[b,c]]);break;case "h":b=b+i[0];d=e=null;g.push(["lineTo",[b,c]]);break;case "V":c=i[0];d=e=null;g.push(["lineTo",
[b,c]]);break;case "v":c=c+i[0];d=e=null;g.push(["lineTo",[b,c]]);break;case "C":b=i[4];c=i[5];d=i[2];e=i[3];g.push(["bezierCurveTo",i]);break;case "c":g.push(["bezierCurveTo",[i[0]+b,i[1]+c,i[2]+b,i[3]+c,i[4]+b,i[5]+c]]);d=b+i[2];e=c+i[3];b=b+i[4];c=c+i[5];break;case "S":if(d==null||!f.match(/[sc]/i)){d=b;e=c}g.push(["bezierCurveTo",[b-(d-b),c-(e-c),i[0],i[1],i[2],i[3]]]);d=i[0];e=i[1];b=i[2];c=i[3];break;case "s":if(d==null||!f.match(/[sc]/i)){d=b;e=c}g.push(["bezierCurveTo",[b-(d-b),c-(e-c),b+
i[0],c+i[1],b+i[2],c+i[3]]]);d=b+i[0];e=c+i[1];b=b+i[2];c=c+i[3];break;case "Q":d=i[0];e=i[1];b=i[2];c=i[3];g.push(["quadraticCurveTo",i]);break;case "q":g.push(["quadraticCurveTo",[i[0]+b,i[1]+c,i[2]+b,i[3]+c]]);d=b+i[0];e=c+i[1];b=b+i[2];c=c+i[3];break;case "T":if(d==null||!f.match(/[qt]/i)){d=b;e=c}else{d=b-(d-b);e=c-(e-c)}g.push(["quadraticCurveTo",[d,e,i[0],i[1]]]);d=b-(d-b);e=c-(e-c);b=i[0];c=i[1];break;case "t":if(d==null||!f.match(/[qt]/i)){d=b;e=c}else{d=b-(d-b);e=c-(e-c)}g.push(["quadraticCurveTo",
[d,e,b+i[0],c+i[1]]]);b=b+i[0];c=c+i[1];break;case "A":f=this.solveArc(b,c,i);for(b=0;b<f.length;b++)f[b][2]=h;g.push.apply(g,f);b=i[5];c=i[6];break;case "a":i[5]=i[5]+b;i[6]=i[6]+c;f=this.solveArc(b,c,i);for(b=0;b<f.length;b++)f[b][2]=h;g.push.apply(g,f);b=i[5];c=i[6];break;case "Z":g.push(["closePath",[]]);break;case "z":g.push(["closePath",[]])}f=j}return g},solveArc:function(a,b,c){a=this.arcToSegments(c[5],c[6],c[0],c[1],c[3],c[4],c[2],a,b);b=[];for(c=0;c<a.length;c++)b.push(["bezierCurveTo",
this.segmentToBezier.apply(this,a[c])]);return b},arcToSegments:function(a,b,c,d,e,f,g,h,i){var j=g*(Math.PI/180),g=Math.sin(j),j=Math.cos(j),c=Math.abs(c),d=Math.abs(d),k=j*(h-a)*0.5+g*(i-b)*0.5,l=j*(i-b)*0.5-g*(h-a)*0.5,k=k*k/(c*c)+l*l/(d*d);if(k>1){k=Math.sqrt(k);c=c*k;d=d*k}var m=j/c,n=g/c,l=-g/d,o=j/d,k=m*h+n*i,h=l*h+o*i,i=m*a+n*b,b=l*a+o*b,a=1/((i-k)*(i-k)+(b-h)*(b-h))-0.25;a<0&&(a=0);a=Math.sqrt(a);f==e&&(a=-a);e=0.5*(k+i)-a*(b-h);a=0.5*(h+b)+a*(i-k);k=Math.atan2(h-a,k-e);b=Math.atan2(b-a,
i-e)-k;b<0&&f==1?b=b+2*Math.PI:b>0&&f==0&&(b=b-2*Math.PI);f=Math.ceil(Math.abs(b/(Math.PI*0.5+0.001)));h=[];for(i=0;i<f;i++)h[i]=[e,a,k+i*b/f,k+(i+1)*b/f,c,d,g,j];return h},segmentToBezier:function(a,b,c,d,e,f,g,h){var i=h*e,j=-g*f,e=g*e,f=h*f,h=0.5*(d-c),g=8/3*Math.sin(h*0.5)*Math.sin(h*0.5)/Math.sin(h),h=a+Math.cos(c)-g*Math.sin(c),c=b+Math.sin(c)+g*Math.cos(c),a=a+Math.cos(d),b=b+Math.sin(d),k=a+g*Math.sin(d),d=b-g*Math.cos(d);return[i*h+j*c,e*h+f*c,i*k+j*d,e*k+f*d,i*a+j*b,e*a+f*b]},getLength:function(){var a=
this.getSegments();if(a.arcLength==null)for(var b=a.arcLength=0,c=0,d=0;d<a.length;d++){var e=a[d][1];if(!(e.length<2)){switch(a[d][0]){case "bezierCurveTo":a[d][3]=Curves.cubicLength([b,c],[e[0],e[1]],[e[2],e[3]],[e[4],e[5]]);break;case "quadraticCurveTo":a[d][3]=Curves.quadraticLength([b,c],[e[0],e[1]],[e[2],e[3]]);break;case "lineTo":a[d][3]=Curves.lineLength([b,c],[e[0],e[1]])}if(a[d][3])a.arcLength=a.arcLength+a[d][3];b=e[e.length-2];c=e[e.length-1]}}return a.arcLength},pointAngleAt:function(a,
b){for(var c=[],d=this.getSegments(),e=this.getLength(),f=0,g=0,h=0;h<d.length;h++){var i=d[h];if(!(i[1].length<2)){i[0]!="moveTo"&&c.push([f,g,i]);f=i[1][i[1].length-2];g=i[1][i[1].length-1]}}if(c.length<1)return{point:[f,g],angle:0};if(a>=1)var j=1,i=c[c.length-1];else if(b&&b.discrete)var k=Math.floor(a*c.length),i=c[k],j=0;else if(b&&b.linear){k=a*c.length;j=k-Math.floor(k);i=c[Math.floor(k)]}else{i=a*e;for(h=d=0;h<c.length;h++){if(d+c[h][2][3]>i){k=h;j=(i-d)/c[h][2][3];break}d=d+c[h][2][3]}i=
c[k]}c=0;h=i[2][1];switch(i[2][0]){case "bezierCurveTo":return Curves.cubicLengthPointAngle([i[0],i[1]],[h[0],h[1]],[h[2],h[3]],[h[4],h[5]],j);case "quadraticCurveTo":return Curves.quadraticLengthPointAngle([i[0],i[1]],[h[0],h[1]],[h[2],h[3]],j);case "lineTo":f=Curves.linearValue(i[0],h[0],j);g=Curves.linearValue(i[1],h[1],j);c=Curves.lineAngle([i[0],i[1]],[h[0],h[1]],j)}return{point:[f,g],angle:c}}});
ImageNode=Klass(Drawable,{centered:!1,usePattern:!1,sX:0,sY:0,sWidth:null,sHeight:null,dX:0,dY:0,dWidth:null,dHeight:null,initialize:function(a,b){this.image=a;Drawable.initialize.call(this,b)},drawGeometry:function(a){if(Object.isImageLoaded(this.image)){var b=this.dWidth==null?this.image.width:this.dWidth,c=this.dHeight==null?this.image.height:this.dHeight,d=this.dX+(this.centered?-b*0.5:0),e=this.dY+(this.centered?-c*0.5:0);if(this.dWidth!=null)this.sWidth!=null?a.drawImage(this.image,this.sX,
this.sY,this.sWidth,this.sHeight,d,e,b,c):a.drawImage(this.image,d,e,b,c);else{b=this.image.width;c=this.image.height;if(this.usePattern){if(!this.imagePattern)this.imagePattern=new Pattern(this.image,"repeat");var f=this.imagePattern.compiled;f||(f=this.imagePattern.compile(a));a.save();a.beginPath();a.rect(d,e,b,c);a.setFillStyle(f);a.fill();a.restore();a.beginPath()}else a.drawImage(this.image,d,e)}}else{b=this.dWidth;c=this.dHeight;if(!b||!c)return;d=this.dX+(this.centered?-b*0.5:0);e=this.dY+
(this.centered?-c*0.5:0)}a.rect(d,e,b,c)},drawPickingPath:function(a){var b=this.dX+(this.centered?-this.image.width*0.5:0),c=this.dY+(this.centered?-this.image.height*0.5:0),d=this.dWidth,e=this.dHeight;if(this.dWidth==null){d=this.image.width;e=this.image.height}a.rect(b,c,d,e)},isPointInPath:function(a,b){a=a-this.dX;b=b-this.dY;if(this.centered){a=a+this.image.width*0.5;b=b+this.image.height*0.5}var c=this.dWidth,d=this.dHeight;if(this.dWidth==null){c=this.image.width;d=this.image.height}return a>=
0&&a<=c&&b>=0&&b<=d},getBoundingBox:function(){x=this.dX;y=this.dY;if(this.centered){x=x-this.image.width*0.5;y=y-this.image.height*0.5}var a=this.dWidth,b=this.dHeight;if(this.dWidth==null){a=this.image.width;b=this.image.height}return[x,y,a,b]}});ImageNode.load=function(a){var b=new Image;b.src=a;return new ImageNode(b)};
TextNode=Klass(Drawable,{text:"Text",align:"start",baseline:"alphabetic",accuratePicking:!1,asPath:!1,pathGeometry:null,maxWidth:null,width:0,height:20,cx:0,cy:0,__drawMethodName:"draw"+CanvasSupport.getTextBackend(),__pickingMethodName:"drawPickingPath"+CanvasSupport.getTextBackend(),initialize:function(a,b){this.lastText=this.text;this.text=a;Drawable.initialize.call(this,b)},drawGeometry:function(a){this.drawUsing(a,this.__drawMethodName)},drawPickingPath:function(a){this.drawUsing(a,this.__pickingMethodName)},
drawUsing:function(a,b){if(this.text&&this.text.length!=0){if(this.lastText!=this.text||this.lastStyle!=a.font){this.dimensions=this.measureText(a);this.lastText=this.text;this.lastStyle=a.font}if(this[b])this[b](a)}},measureText:function(a){var b="measureText"+CanvasSupport.getTextBackend().capitalize();return this[b]?this[b](a):{width:0,height:0}},computeXForAlign:function(){if(this.align=="left")return 0;if(this.align=="right")return-this.dimensions.width;if(this.align=="center")return-this.dimensions.width*
0.5},measureTextHTML5:function(a){return{width:a.measureText(this.text).width,height:20}},drawHTML5:function(a){this.maxWidth?a.fillText(this.text,this.cx,this.cy,this.maxWidth):a.fillText(this.text,this.cx,this.cy,500)},drawPickingPathHTML5:function(a){a.rect(this.cx,this.cy-15,this.dimensions.width,this.dimensions.height)},measureTextMozText:function(a){return{width:a.mozMeasureText(this.text),height:20}},drawMozText:function(a){var b=this.cx+this.computeXForAlign(),c=this.cy+0;if(this.pathGeometry){this.pathGeometry.draw(a);
a.mozDrawTextAlongPath(this.text,this.path)}else{a.save();a.translate(b,c);this.asPath?a.mozPathText(this.text):a.mozDrawText(this.text);a.restore()}},drawPickingPathMozText:function(a){var b=this.cx+this.computeXForAlign(),c=this.cy+0;if(this.pathGeometry)this.pathGeometry.draw(a);else if(this.accuratePicking){a.save();a.translate(b,c);a.mozPathText(this.text);a.restore()}else a.rect(b,c-15,this.dimensions.width,this.dimensions.height)},drawDrawString:function(a){var b=this.cx+this.computeXForAlign();
a.drawString(b,this.cy+0,this.text)},measureTextPerfectWorld:function(a){return a.measureText(this.text)},drawPerfectWorld:function(a){if(this.pathGeometry){this.pathGeometry.draw(a);this.asPath?a.pathTextAlongPath(this.text):a.drawTextAlongPath(this.text)}else this.asPath?a.pathText(this.text):a.drawText(this.text)},drawPickingPathPerfectWorld:function(a){this.accuratePicking?this.pathGeometry?a.pathTextAlongPath(this.text):a.pathText(this.text):this.pathGeometry?a.textRectAlongPath(this.text):a.textRect(this.text)}});
Gradient=Klass({type:"linear",isPattern:!0,startX:0,startY:0,endX:1,endY:0,startRadius:0,endRadius:1,colorStops:[],initialize:function(a){this.colorStops=[[0,"#000000"],[1,"#FFFFFF"]];a&&Object.extend(this,a)},compile:function(a){for(var a=this.type=="linear"?a.createLinearGradient(this.startX,this.startY,this.endX,this.endY):a.createRadialGradient(this.startX,this.startY,this.startRadius,this.endX,this.endY,this.endRadius),b=0;b<this.colorStops.length;b++){var c=this.colorStops[b];if(typeof c[1]==
"string")a.addColorStop(c[0],c[1]);else{var d=c[1],e=d.length==3?1:d[3],d="rgba("+d.slice(0,3).map(Math.round).join(",")+", "+e+")";a.addColorStop(c[0],d)}}Object.extend(a,Transformable.prototype);a.transformList=this.transformList;a.scale=this.scale;a.x=this.x;a.y=this.y;a.matrix=this.matrix;a.rotation=this.rotation;a.units=this.units;if(!a.isMockObject)this.compiled=a;return a}});
Pattern=Klass({isPattern:!0,repeat:"repeat",initialize:function(a,b){this.image=a;if(b)this.repeat=b},compile:function(a){a=a.createPattern(this.image,this.repeat);Object.extend(a,Transformable.prototype);a.transformList=this.transformList;a.scale=this.scale;a.x=this.x;a.y=this.y;a.matrix=this.matrix;a.rotation=this.rotation;a.units=this.units;if(!a.isMockObject)this.compiled=a;return a}});
SVGParser={load:function(a,b){if(!b.onSuccess)throw"Need to provide an onSuccess function.";if(!b.filename)b.filename=a;var c=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP.3.0");c.open("GET",a,true);c.overrideMimeType("text/xml");var d=false;c.onreadystatechange=function(){if(c.readyState==4)if(c.status==200||c.status==0){try{var e=c.responseXML,g=SVGParser.parse(e,b);g.svgRootElement=e}catch(h){if(b.onFailure)b.onFailure(c,h,a,b);return}b.onSuccess(g,c,a,b)}else{if(b.onFailure&&
!d)b.onFailure(c,null,a,b)}else if(c.readyState==3&&b.onLoading)b.onLoading(c,a,b)};try{c.send(null)}catch(e){if(b.onFailure){b.onFailure(c,e,a,b);d=true}c.abort()}},parse:function(a,b){var c=new CanvasNode,d=b.width,e=b.height,f=b.fontSize;c.innerWidth=d||window.innerWidth;c.innerHeight=e||window.innerHeight;c.innerSize=Math.sqrt(d*d+e*e)/Math.sqrt(2);c.fontSize=f||12;c.filename=b.filename||".";d={};e={ids:{},classes:{},tags:{}};c.color=b.currentColor||"black";this.parseChildren(a,c,d,e);c.defs=
d;c.style=e;return c},parsePreserveAspectRatio:function(a,b,c,d,e){var f=(a||"").split(/\s+/);f[0]=="defer"&&f.shift();var g=f[0]||"xMidYMid",h=b/d,i=c/e,a={x:0,y:0,w:h,h:i};if(g=="none")return a;a.w=a.h=((f[1]||"meet")=="meet"?Math.min:Math.max)(h,i);f=g.slice(1,4).toLowerCase();g=this.SVGAlignMap[g.slice(5,8).toLowerCase()]||0;a.x=(this.SVGAlignMap[f]||0)*(b-d*a.w);a.y=g*(c-e*a.h);return a},SVGAlignMap:{min:0,mid:0.5,max:1},SVGTagMapping:{svg:function(a,b){var c=new Rectangle;c.width=0;c.height=
0;c.doFill=function(){};c.doStroke=function(){};c.drawMarkers=function(){};c.fill="black";c.stroke="none";var d=a.getAttribute("viewBox"),e=a.getAttribute("width"),f=a.getAttribute("height");e?f||(f=e):e=f;if(e)var g=this.parseUnit(e,b,"x"),h=this.parseUnit(f,b,"y");if(d){xywh=d.match(/[-+]?\d+/g).map(parseFloat);c.cx=xywh[0];c.cy=xywh[1];c.width=xywh[2];c.height=xywh[3];var f=b.innerWidth=c.width,i=b.innerHeight=c.height;b.innerSize=Math.sqrt(f*f+i*i)/Math.sqrt(2);if(a.getAttribute("overflow")!=
"visible")c.clip=true}if(e){if(d){d=this.parsePreserveAspectRatio(a.getAttribute("preserveAspectRatio"),g,h,c.width,c.height);c.cx=c.cx-d.x/d.w;c.cy=c.cy-d.y/d.h;c.width=g/d.w;c.height=h/d.h;c.x=c.x+d.x;c.y=c.y+d.y;c.scale=[d.w,d.h]}b.docWidth=g;b.docHeight=h}return c},marker:function(a,b){var c=new CanvasNode;c.draw=function(a){if(!(this.overflow!="hidden"&&this.viewBox)){a.beginPath();a.rect(this.viewBox[0],this.viewBox[1],this.viewBox[2],this.viewBox[3]);a.clip()}};var d=-this.parseUnit(a.getAttribute("refX"),
b,"x")||0,e=-this.parseUnit(a.getAttribute("refY"),b,"y")||0;c.transformList=[["translate",[d,e]]];c.markerUnits=a.getAttribute("markerUnits")||"strokeWidth";c.markerWidth=this.parseUnit(a.getAttribute("markerWidth"),b,"x")||3;c.markerHeight=this.parseUnit(a.getAttribute("markerHeight"),b,"y")||3;c.overflow=a.getAttribute("overflow")||"hidden";c.viewBox=a.getAttribute("viewBox");c.orient=a.getAttribute("orient")||0;if(c.orient&&c.orient!="auto")c.orient=parseFloat(c.orient)*SVGMapping.DEG_TO_RAD_FACTOR;
if(c.viewBox){c.viewBox=c.viewBox.strip().split(/[\s,]+/g).map(parseFloat);d=c.viewBox[2]-c.viewBox[0];e=c.viewBox[3]-c.viewBox[1];if(c.markerWidth){d=sy=Math.min(c.markerWidth/d,c.markerHeight/e);c.transformList.unshift(["scale",[d,sy]])}}return c},clipPath:function(a){var b=new CanvasNode;b.units=a.getAttribute("clipPathUnits");return b},title:function(a,b){b.root.title=a.textContent},desc:function(a,b){b.root.description=a.textContent},metadata:function(a,b){b.root.metadata=a},parseAnimateTag:function(a,
b){var c=SVGParser.SVGTagMapping.parseTime(a.getAttribute("begin")),d=SVGParser.SVGTagMapping.parseTime(a.getAttribute("dur")),e=SVGParser.SVGTagMapping.parseTime(a.getAttribute("end"));d==null&&(d=e-c);var d=isNaN(d)?0:d,e=a.getAttribute("attributeName"),f=a.getAttribute("fill");if(b.tagName=="rect"){e=="x"&&(e="cx");e=="y"&&(e="cy")}var g=a.getAttribute("accumulate")=="sum",h=a.getAttribute("additive"),h=h?h=="sum":g,i=a.getAttribute("repeatCount"),i=i=="indefinite"?true:parseFloat(i);if(!i&&d>
0){i=a.getAttribute("repeatDur");i=i=="indefinite"?true:SVGParser.SVGTagMapping.parseTime(i)/d}return{after:isNaN(c)?0:c,duration:d,restart:a.getAttribute("restart"),calcMode:a.getAttribute("calcMode"),additive:h,accumulate:g,repeat:i,variable:e,fill:f}},parseTime:function(a){if(!a)return null;if(a.match(/[0-9]$/)){var a=a.split(":"),b=a[a.length-1]||0,c=a[a.length-2]||0;return(parseFloat(a[a.length-3]||0)*3600+parseFloat(c)*60+parseFloat(b))*1E3}b=60;a.match(/s$/i)?b=1:a.match(/h$/i)&&(b=3600);return parseFloat(a)*
b*1E3},animate:function(a,b){var c=this.parseUnit(a.getAttribute("from"),b,"x"),d=this.parseUnit(a.getAttribute("to"),b,"x"),e=this.parseUnit(a.getAttribute("by"),b,"x"),f=SVGParser.SVGTagMapping.parseAnimateTag(a,b);if(a.getAttribute("values"))var g=this,h=a.getAttribute("values"),h=h.split(";").map(function(a){var c=a.split(/[, ]+/);return c.length>2?c.map(function(a){return g.parseUnit(a,b,"x")}):c.length>1?[g.parseUnit(c[0],b,"x"),g.parseUnit(c[1],b,"y")]:g.parseUnit(a,b,"x")});else d==null&&
(d=c+e);b.after(f.after,function(){if(f.fill=="remove"){var a=Object.clone(this[f.variable]);this.after(f.duration,function(){this[f.variable]=a})}if(h){if(f.additive){var b=this[f.variable];h=h.map(function(a){return Object.sum(a,b)})}var g=0,l=[];if(h[0]instanceof Array)for(var m=1;m<h.length;m++){var n=Object.sub(h[m]-h[m-1]),n=Math.sqrt(n.reduce(function(a,b){return a+b*b},0));l.push(n);g=g+n}else for(m=1;m<h.length;m++){n=Math.abs(h[m]-h[m-1]);l.push(n);g=g+n}this.animate(function(a){if(a==1)this[f.variable]=
h[h.length-1];else{if(f.calcMode=="paced"){for(var a=a*g,b=0,c,d,e=0;e<l.length;e++){if(b+l[e]>a){c=e;d=(a-b)/l[e];break}b=b+l[e]}a=c}else{c=a*(h.length-1);a=Math.floor(c);d=c-a}c=a+1;this.tweenVariable(f.variable,h[a],h[c],d,f.calcMode)}},c,d,f.duration,"linear",{repeat:f.repeat,additive:f.additive,accumulate:f.accumulate})}else{if(c==null){c=this[f.variable];e!=null&&(d=c+e)}if(f.additive){c=Object.sum(c,this[f.variable]);d=Object.sum(d,this[f.variable])}this.animate(f.variable,c,d,f.duration,f.calcMode,
{repeat:f.repeat,additive:f.additive,accumulate:f.accumulate})}})},set:function(a,b){var c=a.getAttribute("to"),d=SVGParser.SVGTagMapping.parseAnimateTag(a,b);b.after(d.after,function(){if(d.fill=="remove"){var a=Object.clone(this[d.variable]);this.after(d.duration,function(){this[d.variable]=a})}this[d.variable]=c})},animateMotion:function(a,b){var c;if(a.getAttribute("path"))c=new Path(a.getAttribute("path"));else if(a.getAttribute("values")){c=a.getAttribute("values");c=new Path("M"+c.split(";").join("L"))}else if(a.getAttribute("from")||
a.getAttribute("to")||a.getAttribute("by")){c=a.getAttribute("from");var d=a.getAttribute("to"),e=a.getAttribute("by");c||(c="0,0");c=new Path("M"+c+(d?"L"+d:"l"+e))}var f=new CanvasNode;f.__motionPath=c;var g=a.getAttribute("rotate"),h=SVGParser.SVGTagMapping.parseAnimateTag(a,b);b.after(h.after,function(){if(h.fill=="remove"){var a=this.x,b=this.y;this.after(h.duration,function(){this.x=a;this.y=b})}this.animate(function(a){a=f.__motionPath.pointAngleAt(a,{discrete:h.calcMode=="discrete",linear:h.calcMode==
"linear"});this.x=a.point[0];this.y=a.point[1];if(g=="auto")this.rotation=a.angle;else if(g=="auto-reverse")this.rotation=a.angle+Math.PI},0,1,h.duration,"linear",{repeat:h.repeat,additive:h.additive,accumulate:h.accumulate})});return f},mpath:function(a,b,c){a=a.getAttribute("xlink:href");a=a.replace(/^#/,"");this.getDef(c,a,function(a){b.__motionPath=a})},animateColor:function(a,b,c){var d=a.getAttribute("from"),e=a.getAttribute("to"),d=SVGParser.SVGMapping.__parseStyle(d,null,c),e=SVGParser.SVGMapping.__parseStyle(e,
null,c),f=SVGParser.SVGTagMapping.parseAnimateTag(a,b);b.after(f.after,function(){if(f.fill=="remove"){var a=Object.clone(this[f.variable]);this.after(f.duration,function(){this[f.variable]=a})}this.animate(f.variable,d,e,f.duration,"linear",{repeat:f.repeat,additive:f.additive,accumulate:f.accumulate})})},animateTransform:function(a,b){var c=a.getAttribute("from"),d=a.getAttribute("to"),e=a.getAttribute("by"),f=SVGParser.SVGTagMapping.parseAnimateTag(a,b);c&&(c=c.split(/[ ,]+/).map(parseFloat));
d&&(d=d.split(/[ ,]+/).map(parseFloat));e&&(e=e.split(/[ ,]+/).map(parseFloat));f.variable=a.getAttribute("type");if(f.variable=="rotate"){f.variable="rotation";c&&(c=c.map(function(a){return a*Math.PI/180}));d&&(d=d.map(function(a){return a*Math.PI/180}));e&&(e=e.map(function(a){return a*Math.PI/180}))}else if(f.variable.match(/^skew/)){c&&(c=c.map(function(a){return a*Math.PI/180}));d&&(d=d.map(function(a){return a*Math.PI/180}));e&&(e=e.map(function(a){return a*Math.PI/180}))}d==null&&(d=Object.sum(c,
e));b.after(f.after,function(){if(f.variable=="translate"){if(c==null){c=[this.x,this.y];e!=null&&(d=Object.sum(c,e))}if(f.fill=="remove"){var a=this.x,b=this.y;this.after(f.duration,function(){this.x=a;this.y=b})}this.animate("x",c[0],d[0],f.duration,"linear",{repeat:f.repeat,additive:f.additive,accumulate:f.accumulate});c[1]!=null&&this.animate("y",c[1],d[1],f.duration,"linear",{repeat:f.repeat,additive:f.additive,accumulate:f.accumulate})}else{c&&c.length==1&&(c=c[0]);d&&d.length==1&&(d=d[0]);
e&&e.length==1&&(e=e[0]);if(c==null){c=this[f.variable];e!=null&&(d=Object.sum(c,e))}if(f.variable=="scale"&&f.additive)f.additive=false;if(f.fill=="remove"){var i=Object.clone(this[f.variable]);this.after(f.duration,function(){this[f.variable]=i})}this.animate(f.variable,c,d,f.duration,"linear",{repeat:f.repeat,additive:f.additive,accumulate:f.accumulate})}})},a:function(a){var b=a.getAttribute("xlink:href")||a.getAttribute("href"),a=a.getAttribute("target");return new LinkNode(b,a)},use:function(a,
b,c){var a=a.getAttribute("xlink:href")||a.getAttribute("href"),d=new CanvasNode;if(a){a=a.replace(/^#/,"");this.getDef(c,a,function(a){a=a.clone();if(d.parent){if(d.stroke)a.stroke=d.stroke;if(d.fill)a.fill=d.fill;d.append(a)}else d=a})}return d},image:function(a,b){var c=a.getAttribute("xlink:href")||a.getAttribute("href");c&&c.search(/^[a-z]+:/i)!=0&&(c=b.root.filename.split("/").slice(0,-1).join("/")+"/"+c);c=new ImageNode(c?Object.loadImage(c):null);c.fill="none";c.dX=this.parseUnit(a.getAttribute("x"),
b,"x")||0;c.dY=this.parseUnit(a.getAttribute("y"),b,"y")||0;c.srcWidth=this.parseUnit(a.getAttribute("width"),b,"x");c.srcHeight=this.parseUnit(a.getAttribute("height"),b,"y");return c},path:function(a){return new Path(a.getAttribute("d"))},polygon:function(a){return new Polygon(a.getAttribute("points").toString().strip().split(/[\s,]+/).map(parseFloat))},polyline:function(a){return new Polygon(a.getAttribute("points").toString().strip().split(/[\s,]+/).map(parseFloat),{closePath:false})},rect:function(a,
b){var c=new Rectangle(this.parseUnit(a.getAttribute("width"),b,"x"),this.parseUnit(a.getAttribute("height"),b,"y"));c.cx=this.parseUnit(a.getAttribute("x"),b,"x")||0;c.cy=this.parseUnit(a.getAttribute("y"),b,"y")||0;c.rx=this.parseUnit(a.getAttribute("rx"),b,"x")||0;c.ry=this.parseUnit(a.getAttribute("ry"),b,"y")||0;return c},line:function(a,b){var c=this.parseUnit(a.getAttribute("x1"),b,"x")||0,d=this.parseUnit(a.getAttribute("y1"),b,"y")||0,e=this.parseUnit(a.getAttribute("x2"),b,"x")||0,f=this.parseUnit(a.getAttribute("y2"),
b,"y")||0;return new Line(c,d,e,f)},circle:function(a,b){var c=new Circle(this.parseUnit(a.getAttribute("r"),b)||0);c.cx=this.parseUnit(a.getAttribute("cx"),b,"x")||0;c.cy=this.parseUnit(a.getAttribute("cy"),b,"y")||0;return c},ellipse:function(a,b){var c=new Ellipse(this.parseUnit(a.getAttribute("rx"),b,"x")||0,this.parseUnit(a.getAttribute("ry"),b,"y")||0);c.cx=this.parseUnit(a.getAttribute("cx"),b,"x")||0;c.cy=this.parseUnit(a.getAttribute("cy"),b,"y")||0;return c},text:function(a,b){var c;c=E("div",
a.textContent.strip());c.style.marginTop="-1em";c.style.whiteSpace="nowrap";c=new ElementNode(c);c.xOffset=this.parseUnit(a.getAttribute("x"),b,"x")||0;c.yOffset=this.parseUnit(a.getAttribute("y"),b,"y")||0;return c},style:function(a,b,c,d){this.parseStyle(a,d)},defs:function(){return new CanvasNode({visible:false})},linearGradient:function(a,b,c,d){var e=new Gradient({type:"linear"});e.color=b.color;a.getAttribute("color")&&SVGParser.SVGMapping.color(e,a.getAttribute("color"),c,d);e.svgNode=a;var b=
a.getAttribute("x1"),f=a.getAttribute("y1"),g=a.getAttribute("x2"),h=a.getAttribute("y2"),i=a.getAttribute("gradientTransform");e.units=a.getAttribute("gradientUnits")||"objectBoundingBox";if(b)e.startX=parseFloat(b)*(b.charAt(b.length-1)=="%"?0.01:1);if(f)e.startY=parseFloat(f)*(f.charAt(f.length-1)=="%"?0.01:1);if(g)e.endX=parseFloat(g)*(g.charAt(g.length-1)=="%"?0.01:1);if(h)e.endY=parseFloat(h)*(h.charAt(h.length-1)=="%"?0.01:1);i&&this.applySVGTransform(e,i,c,d);this.parseStops(e,a,c,d);return e},
radialGradient:function(a,b,c,d){var e=new Gradient({type:"radial"});e.color=b.color;a.getAttribute("color")&&SVGParser.SVGMapping.color(e,a.getAttribute("color"),c,d);e.svgNode=a;var b=a.getAttribute("r"),f=a.getAttribute("fx"),g=a.getAttribute("fy"),h=a.getAttribute("cx"),i=a.getAttribute("cy"),j=a.getAttribute("gradientTransform");e.units=a.getAttribute("gradientUnits")||"objectBoundingBox";if(b)e.endRadius=parseFloat(b)*(b.charAt(b.length-1)=="%"?0.01:1);if(f)e.startX=parseFloat(f)*(f.charAt(f.length-
1)=="%"?0.01:1);if(g)e.startY=parseFloat(g)*(g.charAt(g.length-1)=="%"?0.01:1);if(h)e.endX=parseFloat(h)*(h.charAt(h.length-1)=="%"?0.01:1);if(i)e.endY=parseFloat(i)*(i.charAt(i.length-1)=="%"?0.01:1);j&&this.applySVGTransform(e,j,c,d);this.parseStops(e,a,c,d);return e}},parseChildren:function(a,b,c,d){for(var e=0;e<a.childNodes.length;e++){var f=a.childNodes[e],g=false;if(f.childNodes){if(f.tagName)if(g=this.SVGTagMapping[f.tagName]?this.SVGTagMapping[f.tagName].call(this,f,b,c,d):new CanvasNode){g.root=
b.root;g.fontSize=b.fontSize;g.strokeWidth=b.strokeWidth;if(f.attributes)for(var h=0;h<f.attributes.length;h++){var i=f.attributes[h];if(this.SVGMapping[i.nodeName])this.SVGMapping[i.nodeName](g,i.nodeValue,c,d)}g.id&&this.setDef(c,g.id,g);g.tagName=f.tagName;this.applySVGTransform(g,f.getAttribute("transform"),c,d);this.applySVGStyle(g,f.getAttribute("style"),c,d);g.tagName&&d.tags[g.tagName]&&this.applySVGStyle(g,d.tags[g.tagName],c,d);g.className&&d.classes[g.className]&&this.applySVGStyle(g,d.classes[g.className],
c,d);g.id&&d.ids[g.id]&&this.applySVGStyle(g,d.ids[g.id],c,d);if(!g.marker)g.marker=b.marker;if(!g.markerStart)g.markerStart=b.markerStart;if(!g.markerEnd)g.markerEnd=b.markerEnd;if(!g.markerMid)g.markerMid=b.markerMid}if(g&&g.setRoot){g.zIndex=e;b.append(g);this.parseChildren(f,g,c,d)}}}},parseStyle:function(a,b){for(var c=a.textContent.split(/\}/m),d=0;d<c.length;d++){var e=c[d].split(/\{/m);if(!(e.length<2)){var f=e[0].strip(),e=e[1].strip();switch(f.charAt(0)){case ".":b.classes[f.slice(1)]=e;
break;case "#":b.ids[f.slice(1)]=e;break;default:b.tags[f]=e}}}},parseStops:function(a,b,c,d){var e=b.getAttribute("xlink:href");a.colorStops=[];if(e){e=e.replace(/^#/,"");this.getDef(c,e,function(b){if(a.colorStops.length==0)a.colorStops=b.colorStops})}for(var e=[],f=0;f<b.childNodes.length;f++){var g=b.childNodes[f];if(g.tagName=="stop"){var h=parseFloat(g.getAttribute("offset"));g.getAttribute("offset").search(/%/)!=-1&&(h=h*0.01);h=[h];h.color=a.color;for(var i=0;i<g.attributes.length;i++){var j=
g.attributes[i];if(this.SVGMapping[j.nodeName])this.SVGMapping[j.nodeName](h,j.nodeValue,c,d)}this.applySVGStyle(h,g.getAttribute("style"),c,d);(g=g.getAttribute("id"))&&this.setDef(c,g,h);e.push(h)}}if(e.length>0)a.colorStops=e},applySVGTransform:function(a,b,c,d){if(b){a.transformList=[];for(var b=b.match(/[a-z]+\s*\([^)]*\)/ig),e=0;e<b.length;e++){var f=b[e].split("("),g=f[0].strip();if(this.SVGMapping[g]){f=f[1].strip().slice(0,-1);this.SVGMapping[g](a,f,c,d)}}this.breakDownTransformList(a)}},
breakDownTransformList:function(a){var b=a.transformList;if(a.transformList.length==1){b=b[0];if(b[0]=="translate"){a.x=b[1][0];a.y=b[1][1]}else if(b[0]=="scale")a.scale=b[1];else if(b[0]=="rotate")a.rotation=b[1];else if(b[0]=="matrix")a.matrix=b[1];else if(b[0]=="skewX")a.skewX=b[1][0];else if(b[0]=="skewY")a.skewY=b[1][0];else return;a.transformList=null}},applySVGStyle:function(a,b,c,d){if(b)for(var b=b.split(";"),e=0;e<b.length;e++){var f=b[e].split(":"),g=f[0].strip();if(this.SVGMapping[g]){f=
f[1].strip();this.SVGMapping[g](a,f,c,d)}}},getDef:function(a,b,c){a[b]&&a[b]instanceof Array?a[b].push(c):a[b]?c(a[b]):a[b]=[c]},setDef:function(a,b,c){if(a[b]&&a[b]instanceof Array)for(var d=0;d<a[b].length;d++)a[b][d](c);a[b]=c},parseUnit:function(a,b,c){return a==null?null:this.parseUnitMultiplier(a,b,c)*parseFloat(a.strip())},parseUnitMultiplier:function(a,b,c){var d=this.getCmInPixels();return a.search(/cm$/i)!=-1?d:a.search(/mm$/i)!=-1?0.1*d:a.search(/pt$/i)!=-1?0.0352777778*d:a.search(/pc$/i)!=
-1?0.4233333333*d:a.search(/in$/i)!=-1?2.54*d:a.search(/em$/i)!=-1?b.fontSize:a.search(/ex$/i)!=-1?b.fontSize/2:a.search(/%$/i)!=-1?c=="x"?b.root.innerWidth*0.01:c=="y"?b.root.innerHeight*0.01:b.root.innerSize*0.01:1},getCmInPixels:function(){if(!this.cmInPixels){var a=E("div",{style:{margin:"0px",padding:"0px",width:"1cm",height:"1cm",position:"absolute",visibility:"hidden"}});document.body.appendChild(a);var b=a.offsetWidth;document.body.removeChild(a);this.cmInPixels=b||38}return this.cmInPixels},
getEmInPixels:function(){if(!this.emInPixels){var a=E("div",{style:{margin:"0px",padding:"0px",width:"1em",height:"1em",position:"absolute",visibility:"hidden"}});document.body.appendChild(a);var b=a.offsetWidth;document.body.removeChild(a);this.emInPixels=b||12}return this.emInPixels},getExInPixels:function(){if(!this.exInPixels){var a=E("div",{style:{margin:"0px",padding:"0px",width:"1ex",height:"1ex",position:"absolute",visibility:"hidden"}});document.body.appendChild(a);var b=a.offsetWidth;document.body.removeChild(a);
this.exInPixels=b||6}return this.exInPixels},SVGMapping:{DEG_TO_RAD_FACTOR:Math.PI/180,RAD_TO_DEG_FACTOR:180/Math.PI,parseUnit:function(a,b,c){return SVGParser.parseUnit(a,b,c)},"class":function(a,b){a.className=b},marker:function(a,b,c){SVGParser.getDef(c,b.replace(/^url\(#|\)$/g,""),function(b){a.marker=b})},"marker-start":function(a,b,c){SVGParser.getDef(c,b.replace(/^url\(#|\)$/g,""),function(b){a.markerStart=b})},"marker-end":function(a,b,c){SVGParser.getDef(c,b.replace(/^url\(#|\)$/g,""),function(b){a.markerEnd=
b})},"marker-mid":function(a,b,c){SVGParser.getDef(c,b.replace(/^url\(#|\)$/g,""),function(b){a.markerMid=b})},"clip-path":function(a,b,c){SVGParser.getDef(c,b.replace(/^url\(#|\)$/g,""),function(b){a.clipPath=b})},id:function(a,b){a.id=b},translate:function(a,b){var c=b.split(/[\s,]+/).map(parseFloat);a.transformList.push(["translate",[c[0],c[1]||0]])},rotate:function(a,b){if(!(b=="auto"||b=="auto-reverse")){var c=b.split(/[\s,]+/).map(parseFloat),d=c[0]*this.DEG_TO_RAD_FACTOR;c.length>1?a.transformList.push(["rotate",
[d,c[1],c[2]||0]]):a.transformList.push(["rotate",[d]])}},scale:function(a,b){var c=b.split(/[\s,]+/).map(parseFloat),d=["scale"];d[1]=c.length>1?[c[0],c[1]]:[c[0],c[0]];a.transformList.push(d)},matrix:function(a,b){var c=b.split(/[\s,]+/).map(parseFloat);a.transformList.push(["matrix",c])},skewX:function(a,b){var c=parseFloat(b)*this.DEG_TO_RAD_FACTOR;a.transformList.push(["skewX",[c]])},skewY:function(a,b){var c=parseFloat(b)*this.DEG_TO_RAD_FACTOR;a.transformList.push(["skewY",[c]])},opacity:function(a,
b){a.opacity=parseFloat(b)},display:function(a,b){a.display=b},visibility:function(a,b){a.visibility=b},"stroke-miterlimit":function(a,b){a.miterLimit=parseFloat(b)},"stroke-linecap":function(a,b){a.lineCap=b},"stroke-linejoin":function(a,b){a.lineJoin=b},"stroke-width":function(a,b){a.strokeWidth=this.parseUnit(b,a)},fill:function(a,b,c){a.fill=this.__parseStyle(b,a.fill,c,a.color)},stroke:function(a,b,c){a.stroke=this.__parseStyle(b,a.stroke,c,a.color)},color:function(a,b,c){if(b!="inherit")a.color=
this.__parseStyle(b,false,c,a.color)},"stop-color":function(a,b,c){a[1]=b=="none"?[0,0,0,0]:this.__parseStyle(b,a[1],c,a.color)},"fill-opacity":function(a,b){a.fillOpacity=Math.min(1,Math.max(0,parseFloat(b)))},"stroke-opacity":function(a,b){a.strokeOpacity=Math.min(1,Math.max(0,parseFloat(b)))},"stop-opacity":function(a,b){a[1]=a[1]||[0,0,0];a[1][3]=Math.min(1,Math.max(0,parseFloat(b)))},"text-anchor":function(a,b){a.textAnchor=b;a.setAlign&&(b=="middle"?a.setAlign("center"):a.setAlign(b))},"font-family":function(a,
b){a.fontFamily=b},"font-size":function(a,b){a.fontSize=this.parseUnit(b,a)},__parseStyle:function(a,b,c,d){if(a.charAt(0)=="#"){a.length==4&&(a=a.replace(/([^#])/g,"$1$1"));return c=a.slice(1).match(/../g).map(function(a){return parseInt(a,16)})}if(a.search(/^rgb\(/)!=-1){c=a.slice(4,-1).split(",");for(a=0;a<c.length;a++){b=c[a].strip();c[a]=b.charAt(b.length-1)=="%"?Math.round(parseFloat(b.slice(0,-1))*2.55):parseInt(b)}return c}if(a.search(/^rgba\(/)!=-1){c=a.slice(5,-1).split(",");for(a=0;a<3;a++){b=
c[a].strip();c[a]=b.charAt(b.length-1)=="%"?Math.round(parseFloat(b.slice(0,-1))*2.55):parseInt(b)}b=c[3].strip();c[3]=b.charAt(b.length-1)=="%"?Math.round(parseFloat(b.slice(0,-1))*0.01):Math.max(0,Math.min(1,parseFloat(b)));return c}if(a.search(/^url\(/)!=-1){a=a.match(/\([^)]+\)/)[0].slice(1,-1).replace(/^#/,"");return c[a]?c[a]:"rgba(255,0,255,1)"}return a=="currentColor"?d:a=="none"?"none":a=="freeze"?null:a=="remove"?null:a}}};
